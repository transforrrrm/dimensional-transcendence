<!DOCTYPE html>
<html>
<head>
    <title>维度跃迁 v0.3.1</title>
    <script src="break_eternity.js"></script>
    <style>
        html {
            touch-action: manipulation;
        }

        body {
            background: #ffffff;
            color: #333333;
            font-family: Arial;
            user-select: none;
            margin: 0;
            padding: 0;
            min-width: 320px;
        }
        
        #game {
            max-width: 1000px;
            margin: 0 auto;
            padding: 10px;
        }
        
        #count {
            text-align: center;
            margin: 20px;
        }
        
        #count span:first-child {
            font-size: 16px;
        }
        
        #scalarDisplay {
            font-size: 28px;
            font-weight: bold;
        }
        
        .nav {
            display: flex;
            justify-content: center;
            gap: 0;
            margin: 10px 0;
        }
        
        .nav button {
            padding: 2px 5px;
            font-size: 16px;
        }
        
        button {
            background: #f0f0f0;
            color: #333333;
            border: 1px solid #666666;
            padding: 5px 10px;
            cursor: pointer;
            margin: 2px;
            transition: all 0.2s;
        }
        
        button:hover {
            transform: scale(1.05);
        }
        
        button.active, button:hover {
            background: #000;
            color: #fff;
            border-color: #fff;
        }

        .blue {
            color: blue;
            border-color: blue;
        }
        
        .green {
            color: green;
            border-color: green;
        }

        button.blue.active, button.blue:hover {
            background: blue;
            color: #fff;
            border-color: #fff;
        }
        
        button.green.active, button.green:hover {
            background: green;
            color: #fff;
            border-color: #fff;
        }

        .tabContent {
            display: none;
            padding: 10px 0;
        }
        
        .upgrade {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            border: 1px solid #666666;
            padding: 10px;
        }
        
        .upgrade3d {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            border: 1px solid #666666;
            padding: 10px;
            color: green;
            border-color: green;
        }

        .upgrade3d.maxed {
            background: green;
            color: white;
            border-color: white;
        }

        .vector {
            font-size: 24px;
            color: blue;
            font-family: "Times New Roman", serif;
            font-style: italic;
        }

        .vector3d {
            font-size: 24px;
            color: green;
            font-family: "Times New Roman", serif;
            font-style: italic;
        }

        .d2Text {
            font-size: 24px;
            color: blue;
            font-family: "Times New Roman", serif;
        }
        
        .d3Text {
            font-size: 24px;
            color: green;
            font-family: "Times New Roman", serif;
        }

        .vectorPointText {
            font-size: 16px;
            color: blue;
            font-family: "Times New Roman", serif;
        }
        
        .d3PointText {
            font-size: 16px;
            color: green;
            font-family: "Times New Roman", serif;
        }

        .achievement {
            border: 2px solid #666;
            padding: 10px;
            margin: 5px;
            width: 120px;
            height: 120px;
            display: inline-flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            vertical-align: top;
        }
        
        .achievement.completed {
            background: #aaffaa;
        }
        
        .tooltip {
            position: relative;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            background: #f0f0f0;
            border: 1px solid #666;
            padding: 10px;
            position: absolute;
            z-index: 1;
            width: 200px;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
        }
        
        #clickButton {
            font-size: 20px;
            padding: 15px 30px;
            margin: 20px auto;
            display: block;
            width: 200px;
            aspect-ratio: 2/1;
        }
        
        #ascendBtn {
            position: fixed;
            left: 20px;
            top: 20px;
            color: blue;
            border-color: blue;
            width: 120px;
            aspect-ratio: 2/1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        #thirdDimensionBtn {
            position: fixed;
            right: 20px;
            top: 20px;
            color: green;
            border-color: green;
            width: 120px;
            aspect-ratio: 2/1;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        button.red {
            background: red;
            color: white;
            border-color: darkred;
        }
        
        input {
            width: 4em;
            height: 1.5em;
            text-align: center;
        }
        
        .subNav {
            display: flex;
            justify-content: center;
            gap: 0;
            margin: 10px 0;
        }
        
        .subNav button {
            padding: 2px 5px;
            font-size: 14px;
        }
        
        .vectorUpgrade {
            display: inline-flex;
            flex-direction: column;
            width: 150px;
            height: 130px;
            border: 1px solid blue;
            margin: 5px;
            padding: 30px 10px 10px 10px;
            position: relative;
            vertical-align: top;
        }
        
        .vector3dUpgrade {
            display: inline-flex;
            flex-direction: column;
            width: 150px;
            height: 130px;
            border: 1px solid green;
            margin: 5px;
            padding: 30px 10px 10px 10px;
            position: relative;
            vertical-align: top;
        }

        .vectorUpgrade .index {
            position: absolute;
            top: 5px;
            left: 5px;
            font-weight: bold;
        }
        
        .vector3dUpgrade .index {
            position: absolute;
            top: 5px;
            left: 5px;
            font-weight: bold;
        }

        .vectorUpgrade.purchased {
            background: blue;
            color: white;
            border-color: white;
        }

        .vector3dUpgrade.purchased {
            background: green;
            color: white;
            border-color: white;
        }

        .vectorUpgrade.purchased .vector {
            color: white;
        }
        
        .vector3dUpgrade.purchased .vector3d {
            color: white;
        }

        .formula {
            font-size: 14px;
            color: #666;
            font-style: italic;
        }
        
        .stats-section {
            margin: 10px 0;
            padding: 15px;
            border: 2px solid #000;
            background: rgba(255, 255, 255, 0.8);
            display: inline-block;
            text-align: center;
            min-width: 300px;
        }

        .stats-section h2 {
            margin-top: 0;
            font-size: 24px;
        }

        .stats-container {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-top: 5px;
        }

        .challenge-effect {
            color: #ff0000;
            font-size: 14px;
            margin-top: 5px;
        }

        .blue-text {
            color: blue;
            border: 2px solid blue;
        }

        .green-text {
            color: green;
            border: 2px solid green;
        }

        .purple-text {
            color: purple;
            border: 2px solid purple;
        }

        .settingsContent {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        .version {
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-size: 12px;
            color: #999;
        }

        /* 新增样式 */
        #lengthTab {
            text-align: center;
            font-size: 16px;
        }
        
        #lengthValue {
            font-size: 36px;
            font-weight: bold;
            color: #0000FF;
        }
        
        #areaTab {
            text-align: center;
            font-size: 16px;
            color: #0000FF;
        }
        
        #areaValue {
            font-size: 36px;
            font-weight: bold;
            color: green;
        }
        
        #volumeTab {
            text-align: center;
            font-size: 16px;
            color: green;
        }

        #volumeValue {
            font-size: 36px;
            font-weight: bold;
            color: #FF0000;
        }

        .thruster-container {
            display: flex;
            align-items: center;
            margin-top: 30px;
            justify-content: center;
        }

        .thruster-button {
            background: linear-gradient(135deg, #4a6bff, #8a2be2);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }

        .thruster-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        .thruster-button.maxed {
            background: linear-gradient(135deg, #ffcc00, #ff6600);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .thruster-purchased {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #4a6bff;
        }

        .oom-rate {
            color: #ff0000;
            font-weight: bold;
        }

        .rate {
            font-size: 0.8em;
            color: #666;
            margin-left: 3px;
            font-weight: normal;
        }

        .lengthEffects {
            font-size: 28px;
            font-weight: bold;
        }

        #vectorPointsDisplay {
            position: fixed;
            left: 5px;
            top: 5px;
            color: blue;
            width: 160px;
            text-align: center;
            font-size: 12px;
        }

        #thirdDimensionPointsDisplay {
            position: fixed;
            right: 5px;
            top: 5px;
            color: green;
            width: 160px;
            text-align: center;
            font-size: 12px;
        }

        .challenge-card {
            border: 2px solid #666;
            padding: 15px;
            margin: 10px;
            background: #f8f8f8;
        }

        .challenge-header {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 10px;
        }

        .challenge-desc {
            margin-bottom: 8px;
        }

        .challenge-goal, .challenge-reward {
            margin-bottom: 8px;
            font-style: italic;
        }

        .challenge-card button {
            width: 100%;
            padding: 8px;
            margin-top: 10px;
        }

        .challenge-card button.completed {
            background: #4CAF50;
            color: white;
        }

        .challenge-card button.active {
            background: #f44336;
            color: white;
        }

        .purple {
            color: purple;
            border-color: purple;
        }

        .purple.active, .purple:hover {
            background: purple;
            color: #fff;
            border-color: #fff;
        }

        .automationOption {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 5px 0;
        }

        @keyframes thirdDimensionReset {
            0% {
                opacity: 0;
            }
            50% {
                opacity: 1;
            }
            100% {
                opacity: 0;
            }
        }

        .reset-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 1);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 24px;
            animation: thirdDimensionReset 2s ease-out;
            pointer-events: none;
        }

        .export-dialog {
            background: #f0f0f0;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }

        .export-textarea {
            width: 80%;
            min-width: 300px;
            padding: 10px;
            border: 1px solid #666;
            background: #fff;
            font-family: 'Courier New', monospace;
            resize: vertical;
        }

        .export-button {
            padding: 8px 16px;
            margin: 5px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .export-button:hover {
            background: #45a049;
        }

        /* 通知容器 */
        .notification-container {
            position: fixed;
            top: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 10000;
            max-width: 300px;
        }

        /* 基础通知样式 */
        .notification {
            padding: 12px 16px;
            border-radius: 4px;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            position: relative;
            transform: translateX(0);
            transition: transform 0.3s ease-out, opacity 0.3s;
        }

        /* 消失动画 */
        .notification.fade-out {
            transform: translateX(100%);
            opacity: 0;
        }

        /* 不同类型通知的颜色 */
        .notification.save {
            background: #aaffaa;
            border: 1px solid #66aa66;
        }

        .notification.achievementNotif {
            background: #ffd700;
            border: 1px solid #ccaa00;
        }

        /* 动画定义 */
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
    </style>
</head>
<body>
    <div id="game">
        <div id="count"><span>你的数量是</span><br><span id="scalarDisplay">0</span></div>
        <hr>
        <div class="nav">
            <button onclick="showTab('1d')" id="1dTab">一维</button>
            <button onclick="showTab('2d')" id="2dTab" class="blue" style="display:none">二维</button>
            <button onclick="showTab('3d')" id="3dTab" class="green" style="display:none">三维</button>
            <button onclick="showTab('automation')" id="automationTab" style="display:none">自动化</button>
            <button onclick="showTab('achievements')" id="achievementsTab">成就</button>
            <button onclick="showTab('stats')" id="statsTab">统计</button>
            <button onclick="showTab('settings')" id="settingsTab">设置</button>
        </div>

        <div id="1d" class="tabContent">
            <div class="subNav">
                <button onclick="showSubTab('1dUpgrades')" class="active" id="1dUpgradesBtn">升级</button>
                <button onclick="showSubTab('1dLength')" id="lengthBtn" style="display:none">长度</button>
            </div>
            
            <div id="1dUpgrades" class="subTabContent">
                <button id="clickButton" onclick="clickScalar()">点击获得数量(S)</button>
                <div class="upgrade">
                    <div id="u1Desc">U1(<span id="u1Level">0</span>) 增加数量获取</div>
                    <div>当前：×<span id="u1Multi">1</span></div>
                    <button onclick="buyU1()">购买（<span id="u1Cost">100</span> 数量）</button>
                </div>
                <div class="upgrade" id="u2Container" style="display:none">
                    <div>U2(<span id="u2Level">0</span>) 自动进行点击</div>
                    <div>当前：<span id="u2Multi">0</span>/s</div>
                    <button onclick="buyU2()">购买（<span id="u2Cost">1e8</span> 数量）</button>
                </div>
            </div>
            
            <div id="1dLength" class="subTabContent" style="display:none">
                <div id="lengthTab">
                    <div>你的长度是</div>
                    <div id="lengthValue">0 普朗克长度</div>
                    <br>
                    <div>
                        将你的数量获取×<span class="lengthEffects" id="lengthScalarEffect">1</span>，
                        向量点获取×<span class="lengthEffects" id="lengthVectorEffect">1</span>
                    </div>
                    <div class="formula">(长度获取基于你的数量)</div>
                </div>
            </div>
        </div>

        <div id="2d" class="tabContent">
            <div class="subNav">
                <button onclick="showSubTab('2dVector')" id="vectorBtn" class="blue">向量</button>
                <button onclick="showSubTab('2dUpgrades')" id="upgradesBtn" class="blue">升级</button>
                <button onclick="showSubTab('2dArea')" id="areaBtn" class="blue" style="display:none">面积</button>
            </div>
            
            <div id="2dVector" class="subTabContent"></div>
            <div id="2dUpgrades" class="subTabContent" style="display:none"></div>

            <div id="2dArea" class="subTabContent" style="display:none">
                <div id="areaTab">
                    <div>你的面积是</div>
                    <div id="areaValue">0 普朗克长度²</div>
                    <br>
                    <div>
                        将你的长度获取×<span class="lengthEffects" id="areaLengthEffect">1</span>，
                        U1,U2数量×<span class="lengthEffects" id="areaU1U2Effect">1</span>
                        <span id="areaVectorEffectContainer" style="display:none">，向量点获取×<span class="lengthEffects" id="areaVectorEffect">1</span></span>
                    </div>
                    <div class="formula">(面积获取基于|a×b|)</div>
                </div>
            </div>
        </div>

        <div id="3d" class="tabContent">
            <div class="subNav">
                <button onclick="showSubTab('3dVector')" id="vector3dBtn" class="green">向量</button>
                <button onclick="showSubTab('3dUpgrades')" id="upgrades3dBtn" class="green">升级</button>
                <button onclick="showSubTab('3dChallenges')" id="challengesBtn" class="purple" style="display:none">挑战</button>
                <button onclick="showSubTab('3dVolume')" id="volumeBtn" class="green" style="display:none">体积</button>
            </div>
            
            <div id="3dVector" class="subTabContent"></div>
            <div id="3dUpgrades" class="subTabContent" style="display:none"></div>

            <div id="3dChallenges" class="subTabContent">
                <div class="challenge-card" id="challenge1">
                    <div class="challenge-header">C1<span id="c1Progress">×1</span></div>
                    <div class="challenge-desc">数量获取大幅减少</div>
                    <div class="challenge-goal">目标: <span id="c1Goal">e1e6数量</span></div>
                    <div class="challenge-reward">奖励: <span class="vector">d</span>纵坐标+<span id="c1Reward">0</span></div>
                    <button onclick="toggleChallenge('c1')" id="c1Button">开始</button>
                </div>
    
                <div class="challenge-card" id="challenge2">
                    <div class="challenge-header">C2<span id="c2Progress">×1</span></div>
                    <div class="challenge-desc" id="c2Desc">c已禁用</div>
                    <div class="challenge-goal">目标: <span id="c2Goal">e1e10数量</span></div>
                    <div class="challenge-reward">奖励: 向量点获取指数+<span id="c2Reward">0</span></div>
                    <button onclick="toggleChallenge('c2')" id="c2Button">开始</button>
                </div>
    
                <div class="challenge-card" id="challenge3">
                    <div class="challenge-header">C3<span id="c3Progress">×1</span></div>
                    <div class="challenge-desc">向量点获取随时间快速减少</div>
                    <div class="challenge-goal">目标: <span id="c3Goal">e1e9数量</span></div>
                    <div class="challenge-reward">奖励: <span class="vector">c</span>公式指数+<span id="c3Reward">0</span></div>
                    <button onclick="toggleChallenge('c3')" id="c3Button">开始</button>
                </div>
            </div>

            <div id="3dVolume" class="subTabContent" style="display:none">
                <div id="volumeTab">
                    <div>你的体积是</div>
                    <div id="volumeValue">0 普朗克长度³</div>
                    <br>
                    <div>
                        将你的数量获取^<span class="lengthEffects" id="volumeScalarEffect">1</span>，
                        面积获取×<span class="lengthEffects" id="volumeAreaEffect">1</span></span>
                        <span id="volumeVectorEffectContainer" style="display:none">，向量点获取×<span class="lengthEffects" id="volumeVectorEffect">1</span></span>
                    </div>
                    <div class="formula">(体积获取基于|e×f|)</div>
            
                    <div class="thruster-container">
                        <span style="font-size: 20px; margin-right: 15px;">推进器：</span>
                        <button id="thrusterButton" class="thruster-button" onclick="buyThruster()">(1)体积增加向量点获取<br>花费：10000普朗克体积</button>
                    </div>
                    <div id="thrusterPurchased"></div>
                </div>
            </div>
        </div>

        <div id="automation" class="tabContent">
            <div class="automationOption">
                <label>自动购买一维升级：</label>
                <input type="checkbox" id="autoBuy1DToggle" onchange="toggleAutoBuy1D()" 
                    disabled="true" style="margin-left: 10px;">
            </div>
        </div>

        <div id="achievements" class="tabContent"></div>

        <div id="stats" class="tabContent" style="text-align: center;">
            <div class="stats-container">
                <div class="stats-section">
                    <h2>总计</h2>
                    <div>你已经玩了 <span id="totalPlayTime">0</span>s</div>
                    <div>你最多拥有 <span id="maxScalar">0</span> 数量</div>
                    <div id="maxLengthContainer" style="display:none">你的最大长度是 <span id="maxLength">0</span></div>
                </div>
    
                <div id="twoDStats" class="stats-section blue-text" style="display:none">
                    <h2>二维</h2>
                    <div>自上次升维以来已经经过了 <span id="timeSinceAscend">0</span>s</div>
                    <div>你已经升维了 <span id="ascendCount">0</span> 次</div>
                    <div>你最快一次升维是 <span id="fastestAscend">0</span>s</div>
                    <div>你最多拥有 <span id="maxVectorPoints">0</span> 向量点</div>
                    <div id="maxAreaContainer" style="display:none">你的最大面积是 <span id="maxArea">0</span></div>
                </div>
    
                <div id="threeDStats" class="stats-section green-text" style="display:none">
                    <h2>三维</h2>
                    <div>自上次三维以来已经经过了 <span id="timeSinceThirdDim">0</span>s</div>
                    <div>你已经三维了 <span id="thirdDimCount">0</span> 次</div>
                    <div>你最快一次三维是 <span id="fastestThirdDim">0</span>s</div>
                    <div>你最多拥有 <span id="maxThirdDimPoints">0</span> 三维点</div>
                    <div id="maxVolumeContainer" style="display:none">你的最大体积是 <span id="maxVolume">0</span></div>
                </div>
    
                <div id="challengeStats" class="stats-section purple-text" style="display:none">
                    <h2>挑战最快时间</h2>
                    <div>C1: <span id="bestTimeC1">0</span>s</div>
                    <div>C2: <span id="bestTimeC2">0</span>s</div>
                    <div>C3: <span id="bestTimeC3">0</span>s</div>
                </div>
            </div>
        </div>

        <div id="settings" class="tabContent">
            <div class="settingsContent">
                <button onclick="saveGame()">保存</button>
                <button onclick="importSave()">导入</button>
                <button onclick="importFromFile()">导入文件</button>
                <button onclick="exportSave()">导出</button>
                <button onclick="exportToFile()">导出文件</button>
                <button onclick="tryHardReset()" class="red">硬重置</button><br>
                <label id="confirmLabel" style="display:none"><input type="checkbox" id="resetConfirm"> 升维重置提示</label>
                <label id="thirdDimensionConfirmLabel" style="display:none"><input type="checkbox" id="thirdDimensionResetConfirm"> 三维重置提示</label>
                <label id="challengeConfirmLabel" style="display:none"><input type="checkbox" id="challengeConfirm" checked> 挑战确认提示</label>
            </div>
            <div class="version">v0.3.1</div>
        </div>
    </div>

    <div id="vectorPointsDisplay" style="display:none"></div>
    <div id="thirdDimensionPointsDisplay" style="display:none"></div>

    <button id="ascendBtn" class="ascendBtn"
        onmouseup="tryAscend()">到达10000数量以升维</button>
            
    <button id="thirdDimensionBtn" class="thirdDimensionBtn"
        onmouseup="tryThirdDimension()">到达5e15向量点以三维重置</button>

     <div id="resetAnimation" class="reset-animation" style="display:none"></div>

    <div id="exportContainer" class="export-dialog" style="display: none;">
        <textarea id="exportOutput" class="export-textarea" rows="10" cols="80" readonly></textarea>
        <br>
        <button class="export-button" onclick="copySave()">复制存档</button>
        <button onclick="closeExport()">关闭</button>
    </div>
    <script>
const defaultGame = {
    scalar: new Decimal(0),
    vectorPoints: new Decimal(0),
    thirdDimensionPoints: new Decimal(0),
    length: new Decimal(0),
    lengthUnlocked: false,
    area: new Decimal(0),
    volume: new Decimal(0),
    u1: { 
        level: new Decimal(0),
        cost: new Decimal(100) 
    },
    u2: {
        level: new Decimal(0),
        cost: new Decimal(1e8),
        unlocked: false
    },
    vectorA: {
        x: new Decimal(0),
        y: new Decimal(0)
    },
    vectorB: {
        x: new Decimal(0),
        y: new Decimal(0),
        unlocked: false
    },
    vectorC: {
        x: new Decimal(0),
        y: new Decimal(0),
        unlocked: false
    },
    vectorD: {
        x: new Decimal(0),
        y: new Decimal(0),
        unlocked: false
    },
    vectorE: {
        x: new Decimal(0),
        y: new Decimal(0),
        z: new Decimal(0)
    },
    vectorF: {
        x: new Decimal(0),
        y: new Decimal(0),
        z: new Decimal(0),
        unlocked: false
    },
    vectorG: {
        x: new Decimal(0),
        y: new Decimal(0),
        z: new Decimal(0),
        unlocked: false
    },
    allocationRatios: {
        vectorA: { a: 1, b: 1 },
        vectorB: { a: 1, b: 1 },
        vectorC: { a: 1, b: 1 },
        vectorD: { a: 1, b: 1 },
        vectorE: { a: 1, b: 1, c: 1 },
        vectorF: { a: 1, b: 1, c: 1 },
        vectorG: { a: 1, b: 1, c: 1 }
    },
    vectorUsed: false,
    upgrades: { 
        autoClicker: false, 
        vectorB: false, 
        vectorC: false, 
        vectorD: false,
        lengthEarly: false,
        autoBuy1D: false,
        autoClickerUnlock: false,
        vectorPointsAuto: false,
        vectorF: false,
        areaUnlock: false,
        challengesUnlock: false,
        eExponent: false,
        vectorG: false,
        volumeUnlock: false
    },
    automation: {
        autoBuy1D: false
    },
    lengthExponent: {
        level: new Decimal(0),
        cost: new Decimal(1)
    },
    challenges: {
        active: null,
        progress: {
            c1: { completed: new Decimal(0), active: false },
            c2: { completed: new Decimal(0), active: false },
            c3: { completed: new Decimal(0), active: false }
        }
    },
    thrusterLevel: new Decimal(0),
    achievements: { 
        d2: false, 
        max: false,
        twoDirections: false,
        lightSpeed: false,
        uselessVectors: false,
        longJourney: false,
        fourVectors: false,
        megaVector: false,
        breakInfinity: false,
        thirdDimension: false,
        youAreHacker: false,
        autoEra: false,
        spaceVectorBasic: false,
        area1ym: false,
        mirrorF: false,
        uselessVectorsReal: false,
        notChallenging: false,
        beyondWorld: false,
        hundredKDimensions: false,
        abcdefg: false,
        realWorld: false,
        hundredKThirdDim: false,
        vectorDecrement: false
    },
    stats: {
        gameTime: new Decimal(0),
        challengeRecordTime: {
            c1: new Decimal(1e10),
            c2: new Decimal(1e10),
            c3: new Decimal(1e10)
        },
        maxScalar: new Decimal(0),
        maxLength: new Decimal(0),
        maxArea: new Decimal(0),
        maxVolume: new Decimal(0),
        maxVectorPoints: new Decimal(0),
        maxThirdDimPoints: new Decimal(0),
        ascendCount: new Decimal(0),
        thirdDimCount: new Decimal(0),
        fastestAscend: new Decimal(1e10),
        fastestThirdDim: new Decimal(1e10),
        timeSinceAscend: new Decimal(0),
        timeSinceThirdDim: new Decimal(0)
    },
    settings: { 
        confirm: true,
        thirdDimensionConfirm: true,
        challengeConfirm: true
    },
    hasAscended: false,
    hasThirdDimension: false,
    currentTab: '1d',
    currentSubTabs: {
        '1d': '1dUpgrades',
        '2d': '2dVector',
        '3d': '3dVector',
        'automation': null,
        'achievements': null,
        'stats': null,
        'settings': null
    },
    version: '0.3.1'
};
let game = defaultGame;

let challengeGoals = {
    c1: [
        Decimal.pow(10, 1e6),
        Decimal.pow(10, 1e6),
        Decimal.pow(10, 1e6),
        Decimal.pow(10, 1e6),
        Decimal.pow(10, 1e6)
    ],
    c2: [
        Decimal.pow(10, 1e10),
        Decimal.pow(10, 1e6),
        Decimal.pow(10, 5e6),
        Decimal.pow(10, 1e6),
        Decimal.pow(10, 3e5)
    ],
    c3: [
        Decimal.pow(10, 1e9),
        Decimal.pow(10, 5e9),
        Decimal.pow(10, 5e10),
        Decimal.pow(10, 7e11),
        Decimal.pow(10, 1e13)
    ]
};

let ax, ay, bx, by, cx, cy, dx, dy, ex, ey, ez, fx, fy, fz, gx, gy, gz,
    gain, bGain, cGain, eGain, fGain, gGain;

let currentScalar = game.scalar;
let currentLength = game.length;
let currentArea = game.area;
let currentVolume = game.volume;
let currentVectorPoints = game.vectorPoints;

const PLANCK_LENGTH = new Decimal('1.616255e-35');
const lengthUnits = [
    {unit: "普朗克长度", value: new Decimal(1)},
    {unit: "ym", value: new Decimal(1e-24).div(PLANCK_LENGTH)},
    {unit: "zm", value: new Decimal(1e-21).div(PLANCK_LENGTH)},
    {unit: "am", value: new Decimal(1e-18).div(PLANCK_LENGTH)},
    {unit: "fm", value: new Decimal(1e-15).div(PLANCK_LENGTH)},
    {unit: "pm", value: new Decimal(1e-12).div(PLANCK_LENGTH)},
    {unit: "nm", value: new Decimal(1e-9).div(PLANCK_LENGTH)},
    {unit: "μm", value: new Decimal(1e-6).div(PLANCK_LENGTH)},
    {unit: "mm", value: new Decimal(1e-3).div(PLANCK_LENGTH)},
    {unit: "m", value: new Decimal(1).div(PLANCK_LENGTH)},
    {unit: "km", value: new Decimal(1e3).div(PLANCK_LENGTH)},
    {unit: "Mm", value: new Decimal(1e6).div(PLANCK_LENGTH)},
    {unit: "Gm", value: new Decimal(1e9).div(PLANCK_LENGTH)},
    {unit: "Tm", value: new Decimal(1e12).div(PLANCK_LENGTH)},
    {unit: "Pm", value: new Decimal(1e15).div(PLANCK_LENGTH)},
    {unit: "ly", value: new Decimal('9.461e15').div(PLANCK_LENGTH)},
    {unit: "pc", value: new Decimal('3.086e16').div(PLANCK_LENGTH)},
    {unit: "kpc", value: new Decimal('3.086e19').div(PLANCK_LENGTH)},
    {unit: "Mpc", value: new Decimal('3.086e22').div(PLANCK_LENGTH)},
    {unit: "Gpc", value: new Decimal('3.086e25').div(PLANCK_LENGTH)},
    {unit: "uni", value: new Decimal('8.8e26').div(PLANCK_LENGTH)},
    {unit: "mlt", value: new Decimal('1e1e9')}
];

function getCurrentLengthUnit(number) {
    for (let i = lengthUnits.length - 1; i >= 0; i--) {
        if (number.gte(lengthUnits[i].value)) {
            return lengthUnits[i];
        }
    }
    return lengthUnits[0];
}

function getLengthText(length, current = new Decimal(0), rate = new Decimal(0), dimension = 1) {
    const lengthUnit = getCurrentLengthUnit(length.pow(1/dimension));
    const lengthValue = length.div(lengthUnit.value.pow(dimension));
    let lengthText;
    if (lengthUnit.unit === 'mlt') {
        lengthText = `${formatNumber(length.log(10).div(1e9).div(dimension), lengthUnit.unit)}${toSuperscript(dimension)}`;
    } else {
        lengthText = `${formatNumber(lengthValue, lengthUnit.unit)}${toSuperscript(dimension)}`;
    }
    const rateText = `<span class="rate">${formatRate(current, rate, 1, dimension)}</span>`;
    return lengthText + rateText;
}

function formatNumber(num, unit = "") {
    if (num.lt(1e6)) {
        // 处理小于1e6的情况，保留两位小数并去除无效零
        return num.toFixed(2).replace(/\.?0+$/, '') + unit;
    }

    const originalStr = num.toExponential(6);
    const [fullMatch, prefix, remaining] = originalStr.match(/^(\(e\^\d+\)|e*)(.*)$/);

    // 解析前导e的层级
    let eLevel = 0;
    if (prefix.startsWith('(e^')) {
        eLevel = parseInt(prefix.match(/\d+/)[0]);
    } else {
        eLevel = prefix.length;
    }

    // 解析剩余部分
    let mantissa, exponentValue;
    if (remaining.includes('e')) {
        [mantissa, exponentValue] = remaining.split('e').map(parseFloat);
    } else {
        eLevel--;
        let originalExponentValue = parseFloat(remaining);
        exponentValue = Math.floor(parseFloat(remaining));
        mantissa = Math.pow(10,originalExponentValue - exponentValue);
    }

    // 动态调整层级
    let finalMantissa = '';
    if (exponentValue.toString().length === 5) {
        finalMantissa = mantissa.toFixed(1).replace(/\.0$/, '') + 'e';
    } else if (exponentValue.toString().length === 6) {
        finalMantissa = mantissa.toFixed(0) + 'e';
    } else if (exponentValue >= 1e6) {
        eLevel++;
        exponentValue = new Decimal(exponentValue).toExponential(2).replace('e+','e').replace(/\.?0+e/, 'e')
        finalMantissa = '';
    } else {
        finalMantissa = mantissa.toFixed(2).replace(/\.?0+$/, '') + 'e';
    }

    // 构建最终字符串
    const MAX_ES = 5;
    let prefixFormatted = eLevel > MAX_ES ? `(e^${eLevel})` : 'e'.repeat(eLevel);
  
    return `${prefixFormatted}${finalMantissa}${exponentValue}` + unit;
}

function toSuperscript(num) {
    if (num === 1) return "";
    const superscripts = ['⁰','¹','²','³','⁴','⁵','⁶','⁷','⁸','⁹'];
    return num.toString().split('').map(d => superscripts[d]).join('');
}

function formatRate(current, delta, unit = "", dimension = 1) {
    if (delta.eq(0)) return "";
    if (unit === "") {
        if (current.eq(0)) return `(+${formatNumber(delta)}/s)`;
        const multiplier = current.add(delta.div(20)).div(current);
        const log10 = multiplier.log(10).mul(20);
        if (log10.gte(1) && current.gte(1e100)) {
            return `<span class="oom-rate">(+${formatNumber(log10)}OoMs/s)</span>`;
        }
        return `(+${formatNumber(delta)}/s)`;
    }

    let baseUnit = getCurrentLengthUnit(delta.pow(new Decimal(1).div(dimension)));
    if (baseUnit === lengthUnits[21]) baseUnit = lengthUnits[20];
    const convertedValue = delta.div(baseUnit.value.pow(dimension));
    const convertedUnit = `${baseUnit.unit}${toSuperscript(dimension)}`
    if (current.eq(0)) return `(+${formatNumber(convertedValue, convertedUnit)}/s)`;
    
    const multiplier = current.add(delta.div(20)).div(current);
    const log10 = multiplier.log(10).mul(20);
    const mltThreshold = new Decimal(1e9).mul(dimension);

    if (log10.gte(mltThreshold)) {
        const mltRate = log10.div(mltThreshold);
        return `<span class="oom-rate">(+${formatNumber(mltRate)}mlt/s)</span>`;
    }

    if (log10.gte(1) && current.gte(1e100)) {
        return `<span class="oom-rate">(+${formatNumber(log10)}OoMs/s)</span>`;
    } else {
        return `(+${formatNumber(convertedValue, convertedUnit)}/s)`;
    }
}

function getMultiplier() {
    const baseLevel = game.u1.level.add(game.achievements.d2 ? 1 : 0);
    let areaGain = new Decimal(1);
    if (!(game.challenges.active === 'c2' && game.challenges.progress.c2.completed.gte(4))) {
        areaGain = game.area.add(1);
    }
    let exponent = gGain.mul(game.volume.add(10).log(10));
    let total = baseLevel.mul(gain).mul(areaGain).add(1).pow(2).pow(exponent);
    if (game.length.gt(0)) total = total.mul(game.length.add(1));
    return total;
}

function getAutoClickerSpeed() {
    if (!game.u2.unlocked) return new Decimal(0);
    if (game.challenges.active === 'c2' && 
        game.challenges.progress.c2.completed.gte(4)) {
        return new Decimal(0);
    }
    let areaGain = new Decimal(1);
    if (!(game.challenges.active === 'c2' && game.challenges.progress.c2.completed.gte(4))) {
        areaGain = game.area.add(1);
    }
    let exponent = gGain.mul(game.volume.add(10).log(10));
    let base = game.u2.level.add(game.achievements.breakInfinity ? 1 : 0).mul(areaGain).pow(exponent);
    if (game.vectorB.unlocked) {
        return base.pow(bGain);
    }
    return base;
}

function calculateVectors() {
    ax = game.vectorA.x;
    ay = game.vectorA.y;
    bx = game.vectorB.x.div(1000);
    by = game.vectorB.y.div(1000);
    cx = game.vectorC.x.sqrt().div(100);
    cy = game.vectorC.y.sqrt().div(100);
    dx = game.vectorD.x.gt(0) ? game.vectorD.x.log(10).div(6) : new Decimal(0);
    dy = game.vectorD.y.gt(0) ? game.vectorD.y.log(10).div(6) : new Decimal(0);
    ex = game.vectorE.x;
    ey = game.vectorE.y;
    ez = game.vectorE.z;
    fx = game.vectorF.x.div(10);
    fy = game.vectorF.y.div(10);
    fz = game.vectorF.z.div(10);
    gx = game.vectorG.x.pow(0.5).div(30);
    gy = game.vectorG.y.pow(0.5).div(30);
    gz = game.vectorG.z.pow(0.5).div(30);
    dx = dx.max(1);
    dy = dy.max(1);
    if (game.achievements.uselessVectors) {
        cx = cx.mul(1.5);
        cy = cy.mul(1.5);
    }
    if (game.vectorD.unlocked) {
        const progress = game.challenges.progress.c2.completed;
        if (game.challenges.active !== 'c2' || progress.lt(1)) {
            dy = dy.add(game.challenges.progress.c1.completed.mul(0.05));
        }
        dx = dx.mul(dy);
        dy = dy.pow(2);
        cx = cx.pow(dy);
        cy = cy.pow(dy);
    }
    if (game.vectorC.unlocked) {
        const cEffect = cx.mul(cy).add(1).log(10).add(1);
        ax = ax.mul(cEffect);
        ay = ay.mul(cEffect);
        bx = bx.mul(cEffect);
        by = by.mul(cEffect);
    }
    if (game.vectorD.unlocked) {
        ax = ax.pow(dy);
        ay = ay.pow(dy);
        bx = bx.pow(dy);
        by = by.pow(dy);
    }
    if (game.achievements.spaceVectorBasic) {
        ex = ex.mul(2);
        ey = ey.mul(2);
        ez = ez.mul(2);
    }
    calculateVectorEffects();
}

function calculateVectorEffects() {
    gain = new Decimal(0);
    if (!ax.eq(0) || !ay.eq(0)) {
        if (game.achievements.megaVector) {
            gain = ay.mul(ax.pow(2).add(ay.pow(2)).sqrt());
        } else {
            gain = ax.pow(2).mul(ay).div(ax.pow(2).add(ay.pow(2)).sqrt());
        }
    }
    gain = gain.add(1).mul(game.achievements.max ? 2 : 1);
    let bMagnitude = bx.pow(2).add(by.pow(2)).sqrt();
    bGain = bMagnitude.add(1).log(10)
                  .add(1)
                  .pow(2 + (game.achievements.lightSpeed ? 0.1 : 0) + (game.achievements.autoEra ? 0.1 : 0));
    cGain = cx.mul(cy).add(1).log(10).add(1).pow(game.challenges.progress.c3.completed.add(1));
    eGain = ex.add(1).mul(ey.add(1)).mul(ez.add(1));
    let eExponent = game.achievements.mirrorF ? 11 : 10;
    if (game.upgrades.eExponent) eExponent =Math.pow(eExponent, 2);
    eGain = eGain.pow(eExponent);
    fGain = fx.pow(2).add(fy.pow(2)).add(fz.pow(2)).sqrt().add(1);
    gGain = gz.mul(gy.pow(2).add(gz.pow(2)).sqrt()).add(1).log(10).add(1);
}

function dilate(x, y, base = 10) {
    if (x.eq(0)) return x;
    return new Decimal(base).pow(x.log(base).pow(y));
}

function clickScalar() {
    let total = getMultiplier();
    if (game.challenges.active === 'c1') {
        let challengeCount = game.challenges.progress.c1.completed.add(1).min(5);
        const exponent = 0.95 - 0.1 * challengeCount.toNumber();
        total = dilate(total, exponent);
    }
    game.scalar = game.scalar.add(total);
    updateDisplay();
}

function updateDisplay() {
    let rate = getAutoClickerSpeed().mul(getMultiplier());
    if (game.challenges.active === 'c1') {
        let challengeCount = game.challenges.progress.c1.completed.add(1).min(5);
        const exponent = 0.95 - 0.1 * challengeCount.toNumber();
        rate = dilate(rate, exponent);
    }
    document.getElementById('scalarDisplay').innerHTML = 
        `${formatNumber(game.scalar)}<span class="rate">${formatRate(currentScalar, rate)}</span>`;

    // 显示挑战效果
    if (game.challenges.active === 'c1') {
        const effectDiv = document.createElement('div');
        effectDiv.className = 'challenge-effect';
        const exponent = getMultiplier().mul(getAutoClickerSpeed().max(1)).log(10);
        let challengeCount = game.challenges.progress.c1.completed.add(1).min(5);
        const penalty = 0.05 + 0.1 * challengeCount.toNumber();
        effectDiv.textContent = `数量: √${formatNumber(exponent.pow(penalty))}`;
        document.getElementById('scalarDisplay').appendChild(effectDiv);
    } else if (game.challenges.active === 'c3') {
        const effectDiv = document.createElement('div');
        effectDiv.className = 'challenge-effect';
        const progress = game.challenges.progress.c3.completed.add(1).min(5);
        const timeElapsed = game.stats.timeSinceThirdDim;
        effectDiv.textContent = `向量点: /${formatNumber(new Decimal(2).pow(progress.mul(timeElapsed)))}`;
        document.getElementById('scalarDisplay').appendChild(effectDiv);
    }

    const vecPoints = calculateVecPoints();
    if (game.scalar.gte(10000)) {
        if (vecPoints.lt(100)) {
            const nextPoint = calculateNextPoint(vecPoints);
            document.getElementById('ascendBtn').innerHTML = 
                `升维(A)以获得${formatNumber(vecPoints)}向量点<br><small>下一个在：${formatNumber(nextPoint)}数量</small>`;
        } else {
            document.getElementById('ascendBtn').innerHTML = `升维(A)以获得${formatNumber(vecPoints)}向量点`;
        }
    } else {
        document.getElementById('ascendBtn').innerHTML =`到达10000数量以升维`;
    }

    // 更新资源显示
    document.getElementById('vectorPointsDisplay').innerHTML = `你有<span class="vectorPointText">${formatNumber(game.vectorPoints)}</span><span class="rate">${formatRate(
        currentVectorPoints, 
        game.upgrades.vectorPointsAuto ? vecPoints : new Decimal(0)
    )}</span>向量点`;
    document.getElementById('vectorPointsDisplay').style.display = game.hasAscended ? 'block' : 'none';

    if (game.hasThirdDimension) document.getElementById('thirdDimensionPointsDisplay').innerHTML = `你有<span class="d3PointText">${formatNumber(game.thirdDimensionPoints)}</span>三维点`;
    // 更新三维重置按钮
    if (game.achievements.breakInfinity) {
        if (game.challenges.active) {
            const challengeId = game.challenges.active;
            const progress = game.challenges.progress[challengeId].completed;
            const target = challengeGoals[challengeId][progress.min(4).toNumber()];
            const isComplete = isChallengeComplete(challengeId);
            document.getElementById('thirdDimensionBtn').innerHTML = 
                isComplete ? '完成挑战' : `到达${formatNumber(target)}数量以完成挑战`;
            document.getElementById('thirdDimensionBtn').disabled = !isComplete;
        } else {
            if (game.vectorPoints.gte(5e15)) {
                const thirdDimensionPoints = Decimal.floor(game.vectorPoints.div(5e15).pow(0.1));
                if (thirdDimensionPoints.lt(100)) {
                    document.getElementById('thirdDimensionBtn').innerHTML = 
                        `三维重置(T)以获得${formatNumber(thirdDimensionPoints)}三维点<br><small>下一个在：${formatNumber(calculateNext3dPoint(thirdDimensionPoints))}向量点</small>`;
                } else {
                    document.getElementById('thirdDimensionBtn').innerHTML = 
                        `三维重置(T)以获得${formatNumber(thirdDimensionPoints)}三维点`;
                }
            } else {
                document.getElementById('thirdDimensionBtn').textContent = `到达5e15向量点以三维重置`;
            }
            document.getElementById('thirdDimensionBtn').disabled = false;
        }
    }

    let areaU1U2Effect = new Decimal(1);
    let areaLengthEffect = new Decimal(1);
    let areaVectorEffect = new Decimal(1);
    if (!(game.challenges.active === 'c2' && game.challenges.progress.c2.completed.gte(4))) {
        areaU1U2Effect = game.area.add(1);
        areaLengthEffect = dilate(game.area.add(1), game.achievements.area1ym ? 2.1 : 2);
        areaVectorEffect = game.area.add(10).log(10);
    }
    let volumeScalarEffect = game.volume.add(10).log(10);
    let volumeVectorEffect = new Decimal(1);
    let volumeAreaEffect = game.volume.add(1);
    if (game.thrusterLevel.gt(0)) volumeVectorEffect = dilate(game.volume.add(10).log(10), 2, 2);

    const threshold = game.upgrades.lengthEarly ? 1 : 1e30;
    if (!game.lengthUnlocked && game.scalar.gte(threshold)) {
        game.lengthUnlocked = true;
        document.getElementById('lengthBtn').style.display = 'inline-block';
    }

    if (game.currentTab === '1d') {
        if (game.currentSubTabs['1d'] === '1dUpgrades') {
            // 更新U1显示
            const u1Level = game.u1.level.add(game.achievements.d2 ? 1 : 0);
            let total = gain.mul(areaU1U2Effect);
            document.getElementById('u1Desc').innerHTML = `U1(${formatNumber(u1Level)}${!total.eq(1) ? '×'+formatNumber(total) : ''}) 增加数量获取`;

            document.getElementById('u1Multi').textContent = formatNumber(
                u1Level.mul(total).add(1).pow(2)
            );
            document.getElementById('u1Cost').textContent = formatNumber(game.u1.cost);

            // 更新U2显示
            if (game.u2.unlocked) {
                document.getElementById('u2Container').style.display = 'flex';
                const u2Level = game.u2.level.add(game.achievements.breakInfinity ? 1 : 0);
                document.getElementById('u2Level').textContent = `${formatNumber(u2Level)}${!areaU1U2Effect.eq(1) ? '×'+formatNumber(areaU1U2Effect) : ''}`;
                document.getElementById('u2Multi').textContent = formatNumber(getAutoClickerSpeed());
                document.getElementById('u2Cost').textContent = formatNumber(game.u2.cost);
            }
        }

        if (game.currentSubTabs['1d'] === '1dLength') {
            let lengthGain = getLengthGain();
            document.getElementById('lengthValue').innerHTML = getLengthText(game.length, currentLength, lengthGain, 1);
            document.getElementById('lengthScalarEffect').textContent = formatNumber(game.length.add(1));
            document.getElementById('lengthVectorEffect').textContent = formatNumber(game.length.div(10).add(10).log(10));
        }
    }

    if (game.currentTab === '2d') {
        if (game.currentSubTabs['2d'] === '2dVector') {
            document.getElementById('aContainer').style.display = 'block';
            document.getElementById('vecAX').textContent = formatNumber(ax);
            document.getElementById('vecAY').textContent = formatNumber(ay);
            document.getElementById('currentAGain').textContent = formatNumber(gain);

            let aFormula = game.achievements.megaVector ? 
                "xy/cosθ" : "xycosθ";
            document.getElementById('aFormula').textContent = 
                `(公式:${aFormula}+1)`;

            if (game.vectorB.unlocked) {
                document.getElementById('bContainer').style.display = 'block';
                document.getElementById('vecBX').textContent = formatNumber(bx);
                document.getElementById('vecBY').textContent = formatNumber(by);
                document.getElementById('currentBGain').textContent = formatNumber(bGain);

                let bBase = "lg(|b|+1)+1";
                if (game.achievements.lightSpeed || game.achievements.autoEra) {
                    bBase = `(${bBase})<sup>${2 + (game.achievements.lightSpeed ? 0.1 : 0) + (game.achievements.autoEra ? 0.1 : 0)}</sup>`;
                } else {
                    bBase = `(${bBase})<sup>2</sup>`;
                }
                document.getElementById('bFormula').innerHTML = 
                    `(公式:${bBase})`;
            }
    
            if (game.vectorC.unlocked) {
                document.getElementById('cContainer').style.display = 'block';
                document.getElementById('vecCX').textContent = formatNumber(cx);
                document.getElementById('vecCY').textContent = formatNumber(cy);
                document.getElementById('currentCGain').textContent = formatNumber(cGain);

                let cBase = "lg(xy+1)+1";
                if (game.challenges.progress.c3.completed.gt(0)) {
                    const exponent = game.challenges.progress.c3.completed.add(1);
                    cBase = `(${cBase})<sup>${exponent}</sup>`;
                }
                document.getElementById('cFormula').innerHTML = 
                    `(公式:${cBase})`;
            }

            if (game.vectorD.unlocked) {
                document.getElementById('dContainer').style.display = 'block';
                document.getElementById('vecDX').textContent = formatNumber(dx);
                document.getElementById('vecDY').textContent = formatNumber(dy);
                document.getElementById('currentDGain').textContent = formatNumber(dy);
                document.getElementById('currentDGain2').textContent = formatNumber(dy.pow(0.5));
                document.getElementById('dFormula').innerHTML = 
                    `(公式:^|d|sinθ，×(|d|sinθ)^0.5)`;
            }
        }

        if (game.currentSubTabs['2d'] === '2dArea') {
            // 更新面积显示
            let areaGain = getareaGain();
            document.getElementById('areaValue').innerHTML = getLengthText(game.area, currentArea, areaGain, 2);
            document.getElementById('areaLengthEffect').textContent = formatNumber(areaLengthEffect);
            document.getElementById('areaU1U2Effect').textContent = formatNumber(areaU1U2Effect);
            if (game.achievements.beyondWorld) {
                document.getElementById('areaVectorEffectContainer').style.display = 'inline';
                document.getElementById('areaVectorEffect').textContent = formatNumber(areaVectorEffect);
            }
        }
    }

    if (game.currentTab === '3d') {
        if (game.currentSubTabs['3d'] === '3dVector') {
            if (game.hasThirdDimension) {
                document.getElementById('eContainer').style.display = 'block';
                document.getElementById('vecEX').textContent = formatNumber(ex);
                document.getElementById('vecEY').textContent = formatNumber(ey);
                document.getElementById('vecEZ').textContent = formatNumber(ez);
                document.getElementById('currentEGain').textContent = formatNumber(eGain);
                let eBase = "(x+1)(y+1)(z+1)";
                let eExponent = game.achievements.mirrorF ? 11 : 10;
                if (game.upgrades.eExponent) eExponent =Math.pow(eExponent, 2);
                document.getElementById('eFormula').innerHTML = 
                    `(公式:(${eBase})<sup>${eExponent}</sup>)`;

                if (game.vectorF.unlocked) {
                    document.getElementById('fContainer').style.display = 'block';
                    document.getElementById('vecFX').textContent = formatNumber(fx);
                    document.getElementById('vecFY').textContent = formatNumber(fy);
                    document.getElementById('vecFZ').textContent = formatNumber(fz);
                    document.getElementById('currentFGain').textContent = formatNumber(fGain);
                    document.getElementById('fFormula').innerHTML = 
                        `(公式:|f|+1)`;
                }

                if (game.vectorG.unlocked) {
                    document.getElementById('gContainer').style.display = 'block';
                    document.getElementById('vecGX').textContent = formatNumber(gx);
                    document.getElementById('vecGY').textContent = formatNumber(gy);
                    document.getElementById('vecGZ').textContent = formatNumber(gz);
                    document.getElementById('currentGGain').textContent = formatNumber(gGain);
                    document.getElementById('gFormula').innerHTML = 
                        `(公式:lg(|g|²sinαsinβ+1)+1，其中α,β是g与x轴和面Oxy的夹角)`;
                }
            }
        }

        if (game.currentSubTabs['3d'] === '3dUpgrades') {
            if (game.hasThirdDimension) {
                document.getElementById('lengthEarlyCost').textContent = formatNumber(get3DUpgradeCost('lengthEarly'));
                document.getElementById('autoBuy1DCost').textContent = formatNumber(get3DUpgradeCost('autoBuy1D'));
                document.getElementById('autoClickerUnlockCost').textContent = formatNumber(get3DUpgradeCost('autoClickerUnlock'));
                document.getElementById('vectorPointsAutoCost').textContent = formatNumber(get3DUpgradeCost('vectorPointsAuto'));
        
                const isMaxed = game.lengthExponent.level.gte(7);
                const lengthExponentUpgrade = document.querySelector('#\\33 dUpgrades .upgrade3d');
                if (lengthExponentUpgrade) {
                    if (isMaxed) {
                        lengthExponentUpgrade.classList.add('maxed');
        
                        const button = lengthExponentUpgrade.querySelector('button');
                        if (button) button.disabled = true;
                    }
                }
                document.getElementById('lengthExponent').textContent = (game.achievements.longJourney ? 9 : 10)-game.lengthExponent.level.toNumber();
                document.getElementById('lengthExponentCost').textContent = 
                isMaxed ? "Infinity" : formatNumber(game.lengthExponent.cost);
            }
        }

        if (game.currentSubTabs['3d'] === '3dChallenges') {
            const activeChallenge = game.challenges.active;
    
            for (let i = 1; i <= 3; i++) {
                const challengeId = `c${i}`;
                const progress = game.challenges.progress[challengeId];
                const button = document.getElementById(`${challengeId}Button`);
                const progressDisplay = document.getElementById(`${challengeId}Progress`);
                const goalDisplay = document.getElementById(`c${i}Goal`);
                const isComplete = isChallengeComplete(challengeId);
        
                if (progress.completed.gte(5)) {
                    progressDisplay.textContent = '';
                } else {
                    progressDisplay.textContent = `×${formatNumber(progress.completed.add(1))}`;
                }
        
                if (progress.completed.gte(5)) {
                    button.textContent = '已完成';
                    button.className = 'completed';
                } else if (challengeId === activeChallenge) {
                    button.textContent = isComplete ? '完成' : '退出' ;
                    button.className = isComplete ? 'completed' : '';
                    button.disabled = false;
                } else if (activeChallenge) {
                    button.textContent = '开始';
                    button.className = '';
                    button.disabled = true;
                } else {
                    button.textContent = '开始';
                    button.className = '';
                    button.disabled = false;
                }
                goalDisplay.textContent = `${formatNumber(challengeGoals[challengeId][progress.completed.min(4).toNumber()])}数量`;
                if (challengeId === 'c1') {
                    document.getElementById('c1Reward').textContent = formatNumber(progress.completed.mul(0.05));
                } else if (challengeId === 'c2') {
                    const descs = [
                        '<span class="vector">c</span>',
                        '<span class="vector">c,d</span>',
                        '<span class="vector">a,c,d</span>',
                        '<span class="vector">a,b,c,d</span>',
                        '二维'
                    ];
                    document.getElementById('c2Desc').innerHTML = `${descs[progress.completed.min(4).toNumber()]}已禁用`;
                    const x = progress.completed;
                    document.getElementById('c2Reward').textContent = formatNumber(x.add(1).mul(x).div(200));
                } else if (challengeId === 'c3') {
                    document.getElementById('c3Reward').textContent = formatNumber(progress.completed);
                }
            }
        }

        if (game.currentSubTabs['3d'] === '3dVolume') {
            const volumeGain = getVolumeGain();
            document.getElementById('volumeValue').innerHTML = getLengthText(game.volume, currentVolume, volumeGain, 3);
            document.getElementById('volumeScalarEffect').textContent = formatNumber(volumeScalarEffect);
            document.getElementById('volumeAreaEffect').textContent = formatNumber(volumeAreaEffect);
            if (game.thrusterLevel.gt(0)) {
                document.getElementById('volumeVectorEffectContainer').style.display = 'inline';
                document.getElementById('volumeVectorEffect').textContent = formatNumber(volumeVectorEffect);
            }
    
            // 更新推进器按钮
            const thrusterButton = document.getElementById('thrusterButton');
            if (game.thrusterLevel.gte(1)) {
                thrusterButton.innerHTML = '已满级';
                thrusterButton.classList.add('maxed');
                thrusterButton.disabled = true;
            } else {
                thrusterButton.innerHTML = `(${formatNumber(game.thrusterLevel.add(1))})${getThrusterDescription(game.thrusterLevel.add(1))}<br>花费：${getLengthText(getThrusterCost(game.thrusterLevel.add(1)), new Decimal(0), new Decimal(0), 3)}`;
            }

            // 更新已购买的推进器
            let purchasedHtml = '';
            for (let i = 0; game.thrusterLevel.gt(i); i++) {
                purchasedHtml += `<div class="thruster-purchased">(${i+1})${getThrusterDescription(new Decimal(i+1))}</div>`;
            }
            document.getElementById('thrusterPurchased').innerHTML = purchasedHtml;
        }  
    }

    if (game.upgrades.autoBuy1D) {
        document.getElementById('automationTab').style.display = 'inline-block';
    }

    if (game.currentTab === 'automation') {
        document.getElementById('autoBuy1DToggle').disabled = !game.upgrades.autoBuy1D;
        document.getElementById('autoBuy1DToggle').checked = game.automation.autoBuy1D;
    }

    if (game.currentTab === 'achievements') {
        const achievements = Object.entries(game.achievements).map(([key]) => ({
          id: `${key}Achievement`,
          condition: game.achievements[key]
        }));

        // 批量更新成就显示
        achievements.forEach(ach => {
          document.getElementById(ach.id).className = 
            `achievement tooltip ${ach.condition ? 'completed' : ''}`;
        });

        if (game.achievements.notChallenging) {
            const effect = formatNumber(game.stats.gameTime.sqrt());
            document.getElementById('notChallengingEffect').textContent = effect;
        }
        if (game.achievements.hundredKDimensions) {
            document.getElementById('hundredKDimensionsEffect').textContent = 
                formatNumber(Decimal.pow(10, game.stats.ascendCount.div(10000)));
        }
        if (game.achievements.hundredKThirdDim) {
            document.getElementById('hundredKThirdDimEffect').textContent = 
                formatNumber(game.stats.thirdDimCount.add(10).log(10));
        }
    }

    if (game.scalar.gt(game.stats.maxScalar)) {
        game.stats.maxScalar = game.scalar;
    }
    if (game.length.gt(game.stats.maxLength)) {
        game.stats.maxLength = game.length;
    }
    if (game.vectorPoints.gt(game.stats.maxVectorPoints)) {
        game.stats.maxVectorPoints = game.vectorPoints;
    }
    if (game.volume.gt(game.stats.maxVolume)) {
        game.stats.maxVolume = game.volume;
    }
    if (game.area.gt(game.stats.maxArea)) {
        game.stats.maxArea = game.area;
    }
    if (game.thirdDimensionPoints.gt(game.stats.maxThirdDimPoints)) {
        game.stats.maxThirdDimPoints = game.thirdDimensionPoints;
    }

    if (game.currentTab === 'stats') {
        document.getElementById('totalPlayTime').textContent = 
            formatNumber(game.stats.gameTime);
        document.getElementById('maxScalar').textContent = 
            formatNumber(game.stats.maxScalar);

        if (game.lengthUnlocked || game.hasThirdDimension) {
            document.getElementById('maxLengthContainer').style.display = 'block';
            document.getElementById('maxLength').innerHTML = 
                getLengthText(game.stats.maxLength);
        }

        if (game.hasAscended) {
            document.getElementById('twoDStats').style.display = 'inline-block';
            document.getElementById('maxVectorPoints').textContent = 
                formatNumber(game.stats.maxVectorPoints);
            document.getElementById('timeSinceAscend').textContent =
                formatNumber(game.stats.timeSinceAscend);
            document.getElementById('ascendCount').textContent = 
                formatNumber(game.stats.ascendCount);
            document.getElementById('fastestAscend').textContent = 
                game.stats.fastestAscend.gte(1e10) ? "N/A" : formatNumber(game.stats.fastestAscend);

            if (game.upgrades.areaUnlock) {
                document.getElementById('maxAreaContainer').style.display = 'block';
                document.getElementById('maxArea').innerHTML = 
                    getLengthText(game.stats.maxArea, new Decimal(0), new Decimal(0), 2);
            }
        }

        if (game.hasThirdDimension) {
            document.getElementById('threeDStats').style.display = 'inline-block';
            document.getElementById('maxThirdDimPoints').textContent = 
                formatNumber(game.stats.maxThirdDimPoints);
            document.getElementById('timeSinceThirdDim').textContent = 
                formatNumber(game.stats.timeSinceThirdDim);
            document.getElementById('thirdDimCount').textContent =
                formatNumber(game.stats.thirdDimCount);
            document.getElementById('fastestThirdDim').textContent = 
                game.stats.fastestThirdDim.gte(1e10) ? "N/A" : formatNumber(game.stats.fastestThirdDim);
            if (game.upgrades.volumeUnlock) {
                document.getElementById('maxVolumeContainer').style.display = 'block';
                document.getElementById('maxVolume').innerHTML = 
                    getLengthText(game.stats.maxVolume, new Decimal(0), new Decimal(0), 3);
            }
        }

        if (game.upgrades.challengesUnlock) {
            document.getElementById('challengeStats').style.display = 'inline-block';
            document.getElementById('bestTimeC1').textContent = 
                game.stats.challengeRecordTime.c1.gte(1e10) ? "N/A" : formatNumber(game.stats.challengeRecordTime.c1);
            document.getElementById('bestTimeC2').textContent = 
                game.stats.challengeRecordTime.c2.gte(1e10) ? "N/A" : formatNumber(game.stats.challengeRecordTime.c2)
            document.getElementById('bestTimeC3').textContent = 
                game.stats.challengeRecordTime.c3.gte(1e10) ? "N/A" : formatNumber(game.stats.challengeRecordTime.c3);
        }
    }

    currentScalar = game.scalar;
    currentLength = game.length;
    currentArea = game.area;
    currentVolume = game.volume;
    currentVectorPoints = game.vectorPoints;
}

function calculateNextPoint(required) {
    const baseRequired = required.add(1);
    const lengthBonus = game.length.div(10).add(10).log(10);
    let areaBonus = new Decimal(1);
    if (game.achievements.beyondWorld && !(game.challenges.active === 'c2' && game.challenges.progress.c2.completed.gte(4))) {
        areaBonus = game.area.add(10).log(10);
    }
    let achieveBonus = new Decimal(game.achievements.twoDirections ? 1.1 : 1);
    const volumeBonus = game.thrusterLevel.gt(0) ? dilate(game.volume.add(10).log(10), 2, 2) : new Decimal(1);
    if (game.achievements.thirdDimension) {
        achieveBonus = achieveBonus.mul(2);
    }
    if (game.achievements.notChallenging) {
        achieveBonus = achieveBonus.mul(game.stats.gameTime.sqrt());
    }
    if (game.achievements.abcdefg) {
        achieveBonus = achieveBonus.mul(4);
    }
    let exponent = game.achievements.youAreHacker ? 2.01 : 2;
    const x = game.challenges.progress.c2.completed;
    exponent = x.add(1).mul(x).div(200).add(exponent);
    let decayFactor = new Decimal(1);
    if (game.challenges.active === 'c3') {
        let progress = game.challenges.progress.c3.completed.add(1).min(5);
        const timeElapsed = game.stats.timeSinceThirdDim;
        decayFactor = new Decimal(2).pow(progress.mul(timeElapsed).mul(-1));
    }
    const nextScalar = Decimal.pow(
        10, 
        baseRequired.div(lengthBonus).div(areaBonus).div(volumeBonus).div(achieveBonus
        ).div(fGain).div(decayFactor).pow(exponent.pow(-1)).mul(4)
    ).ceil();
    
    return nextScalar;
}

function calculateNext3dPoint(required) {
    return required.add(1).pow(10).mul(5e15);
}

function calculateVecPoints() {
    if (game.scalar.lte(0)) return new Decimal(0);
    const logValue = game.scalar.log(10);
    const lengthBonus = game.length.div(10).add(10).log(10);
    let areaBonus = new Decimal(1);
    if (game.achievements.beyondWorld && !(game.challenges.active === 'c2' && game.challenges.progress.c2.completed.gte(4))) {
        areaBonus = game.area.add(10).log(10);
    }
    const volumeBonus = game.thrusterLevel.gt(0) ? dilate(game.volume.add(10).log(10), 2, 2) : new Decimal(1);
    let achieveBonus = new Decimal(game.achievements.twoDirections ? 1.1 : 1);
    if (game.achievements.thirdDimension) {
        achieveBonus = achieveBonus.mul(2);
    }
    if (game.achievements.notChallenging) {
        achieveBonus = achieveBonus.mul(game.stats.gameTime.sqrt());
    }
    if (game.achievements.abcdefg) {
        achieveBonus = achieveBonus.mul(4);
    }
    let exponent = game.achievements.youAreHacker ? 2.01 : 2;
    const x = game.challenges.progress.c2.completed;
    exponent = x.add(1).mul(x).div(200).add(exponent);
    let decayFactor = new Decimal(1);
    if (game.challenges.active === 'c3') {
        let progress = game.challenges.progress.c3.completed.add(1).min(5);
        const timeElapsed = game.stats.timeSinceThirdDim;
        decayFactor = new Decimal(2).pow(progress.mul(timeElapsed).mul(-1));
    }
    const vecPoints = Decimal.floor(logValue.div(4).pow(exponent
        ).mul(achieveBonus).mul(lengthBonus).mul(areaBonus).mul(volumeBonus).mul(fGain).mul(decayFactor));
    return vecPoints;
}

function getLengthGain() {
    let lengthGain = new Decimal(0);
    const threshold = game.upgrades.lengthEarly ? 1 : 1e30;
    if (game.scalar.gte(threshold)) {
        let areaLengthEffect = new Decimal(1);
        if (!(game.challenges.active === 'c2' && game.challenges.progress.c2.completed.gte(4))) {
            areaLengthEffect = dilate(game.area.add(1), game.achievements.area1ym ? 2.1 : 2);
        }
        lengthGain = game.scalar.div(threshold).pow(
            1/((game.achievements.longJourney ? 9 : 10)-game.lengthExponent.level.toNumber())
        ).mul(game.achievements.fourVectors ? 2 : 1).mul(areaLengthEffect).mul(eGain);
    }
    return lengthGain;
}

function getareaGain() {
    let areaGain = new Decimal(0);
    if (game.vectorB.unlocked) {
        const crossProduct = ax.mul(by).sub(ay.mul(bx)).abs();
        if (crossProduct.gte(1e200)) {
            areaGain = crossProduct.div(1e200).pow(0.1).mul(game.volume.add(1));
        }
    }
    return areaGain;
}

function getVolumeGain() {
    let volumeGain = new Decimal(0);
    if (game.vectorF.unlocked) {
        const term1 = ey.mul(fz).sub(ez.mul(fy)).pow(2);
        const term2 = ez.mul(fx).sub(ex.mul(fz)).pow(2);
        const term3 = ex.mul(fy).sub(ey.mul(fx)).pow(2);
        const magnitude = term1.add(term2).add(term3).sqrt();
        if (magnitude.gte(2500000)) {
            volumeGain = magnitude.div(2500000).pow(0.5);
        }
    }
    return volumeGain;
}

// 添加推进器相关函数
function getThrusterCost(level) {
    if (level.lt(100)) {
        const index = level.toNumber() - 1;
        const cost = [10000];
        return new Decimal(cost[index]);
    }
}

function getThrusterDescription(level) {
    if (level.lt(100)) {
        const index = level.toNumber() - 1;
        const descriptions = [
            "体积增加向量点获取"
        ];
        return descriptions[index] || "未知效果";
    }
}

function buyThruster() {
    const nextLevel = game.thrusterLevel.add(1);
    const cost = getThrusterCost(nextLevel);
    
    if (game.volume.gte(cost)) {
        game.volume = game.volume.sub(cost);
        game.thrusterLevel = nextLevel;
        updateDisplay();
    }
}

function buyU1(isAuto) {
    if (game.scalar.gte(game.u1.cost)) {
        const ratio = game.scalar.div(game.u1.cost).add(1);
        const logVal = Decimal.log(ratio, 2);
        const max = Decimal.floor(logVal);
        const totalCost = game.u1.cost.mul(Decimal.pow(2, max).sub(1));

        if (totalCost.lte(game.scalar)) {
            game.scalar = game.scalar.sub(totalCost);
            game.u1.level = game.u1.level.add(max);
            game.u1.cost = game.u1.cost.mul(Decimal.pow(2, max));
            if (!isAuto) updateDisplay();
        }
    }
}

function buyU2(isAuto) {
    if (game.u2.unlocked && game.scalar.gte(game.u2.cost)) {
        const ratio = game.scalar.div(game.u2.cost).add(1);
        const logVal = Decimal.log(ratio, 2);
        const max = Decimal.floor(logVal);
        const totalCost = game.u2.cost.mul(Decimal.pow(2, max).sub(1));

        
        if (totalCost.lte(game.scalar)) {
            game.scalar = game.scalar.sub(totalCost);
            game.u2.level = game.u2.level.add(max);
            game.u2.cost = game.u2.cost.mul(Decimal.pow(2, max));
            if (!isAuto) updateDisplay();
        }
    }
}

function tryAscend() {
    if (game.scalar.gte(10000)) {
        if (!game.settings.confirm || confirm("确定要升维吗？")) {
            ascend();
        }
    }
}

function tryThirdDimension() {
    if (game.challenges.active) {
        if (isChallengeComplete(game.challenges.active)) {
            completeChallenge(game.challenges.active);
        }
        return;
    }
    
    if (game.vectorPoints.gte(5e15)) {
        if (!game.settings.thirdDimensionConfirm || confirm("三维重置是一次大的重置。你将重置你所有的二维向量、二维升级、向量点、长度和数量来换取三维点。你将需要一定的时间才能再次回到这里。确定要进行三维重置吗？")) {
            if (game.settings.thirdDimensionConfirm) {
                showResetAnimation();
                setTimeout(thirdDimension, 1000);
            } else {
                thirdDimension();
            }
        }
    }
}

function showResetAnimation() {
    const animation = document.getElementById('resetAnimation');
    animation.style.display = 'flex';
    setTimeout(() => {
        animation.style.display = 'none';
    }, 2000);
}

function ascend() {
    const ascendCount = game.achievements.hundredKThirdDim ? 
        game.stats.thirdDimCount.add(10).log(10) : 1;
    game.stats.ascendCount = game.stats.ascendCount.add(ascendCount);
    if (game.stats.timeSinceAscend.lt(game.stats.fastestAscend)) {
        game.stats.fastestAscend = game.stats.timeSinceAscend;
    }
    game.stats.timeSinceAscend = new Decimal(0);

    game.vectorPoints = game.vectorPoints.add(calculateVecPoints());
    game.scalar = new Decimal(0);
    game.u1 = { level: new Decimal(0), cost: new Decimal(100) };
    game.u2 = { level: new Decimal(0), cost: new Decimal(1e8), unlocked: game.u2.unlocked || game.upgrades.autoClickerUnlock };
    document.getElementById('2dTab').style.display = 'inline-block';
    document.getElementById('confirmLabel').style.display = 'block';
    game.hasAscended = true;
    game.vectorUsed = false;
    
    updateDisplay();
}

function thirdDimension() {
    game.stats.thirdDimCount = game.stats.thirdDimCount.add(1);
    if (game.stats.timeSinceThirdDim.lt(game.stats.fastestThirdDim)) {
        game.stats.fastestThirdDim = game.stats.timeSinceThirdDim;
    }
    game.stats.timeSinceAscend = new Decimal(0);
    game.stats.timeSinceThirdDim = new Decimal(0);
    
    const thirdDimensionPoints = Decimal.floor(game.vectorPoints.div(5e15).pow(0.1));
    game.thirdDimensionPoints = game.thirdDimensionPoints.add(thirdDimensionPoints);

    game.scalar = new Decimal(0);
    game.vectorPoints = new Decimal(0);
    game.length = new Decimal(0);

    game.u1 = { level: new Decimal(0), cost: new Decimal(100) };
    game.u2 = { level: new Decimal(0), cost: new Decimal(1e8), unlocked: game.upgrades.autoClickerUnlock };

    game.vectorA = { x: new Decimal(0), y: new Decimal(0) };
    game.vectorB = { x: new Decimal(0), y: new Decimal(0), unlocked: false };
    game.vectorC = { x: new Decimal(0), y: new Decimal(0), unlocked: false };
    game.vectorD = { x: new Decimal(0), y: new Decimal(0), unlocked: false };
    game.vectorUsed = false;

    game.upgrades.autoClicker = game.upgrades.autoClickerUnlock;
    game.upgrades.vectorB = false;
    game.upgrades.vectorC = false; 
    game.upgrades.vectorD = false;

    if (!game.upgrades.autoClickerUnlock) {
        document.getElementById('autoClickerUpgrade').classList.remove('purchased');
        document.getElementById('u2Container').style.display = 'none';
    }
    document.getElementById('vectorBUpgrade').classList.remove('purchased');
    document.getElementById('vectorCUpgrade').classList.remove('purchased');
    document.getElementById('vectorDUpgrade').classList.remove('purchased');

    document.getElementById('bContainer').style.display = 'none';
    document.getElementById('cContainer').style.display = 'none';
    document.getElementById('dContainer').style.display = 'none';
    
    game.lengthUnlocked = false;
    document.getElementById('lengthBtn').style.display = 'none';
    game.currentSubTabs['1d'] = '1dUpgrades';

    document.getElementById('3dTab').style.display = 'inline-block';
    document.getElementById('thirdDimensionConfirmLabel').style.display = 'block';
    game.hasThirdDimension = true;
    calculateVectors();
    updateDisplay();
    showTab(game.currentTab);
    
    if (!game.achievements.thirdDimension) {
        game.achievements.thirdDimension = true;
        showAchievementNotification("成就达成：三维世界");
    }
}

function parseInputToDecimal(inputValue) {
    try {
        return new Decimal(inputValue);
    } catch (e) {
        return new Decimal(1);
    }
}

// 统一分配函数
function allocatePoints(vectorKey, dimension = 2) {
    const vector = game[vectorKey];
    if (!vector.unlocked && vectorKey != 'vectorA' && vectorKey != 'vectorE') return;

    if (game.challenges.active === 'c2') {
        const progress = game.challenges.progress.c2.completed;
        
        if ((progress.gte(2) && vectorKey === 'vectorA') ||  // 禁用a向量
            (progress.gte(3) && vectorKey === 'vectorB') || // 禁用b向量
            (progress.gte(0) && vectorKey === 'vectorC') || // 禁用c向量
            (progress.gte(1) && vectorKey === 'vectorD')) { // 禁用d向量
            return;
        }
    }
    
    // 动态获取元素
    const prefix = vectorKey.replace('vector', '');
    let ratioA, ratioB, ratioC, allocateAmount;
    
    if (dimension === 3) {
        ratioA = parseInputToDecimal(document.getElementById(`ratio${prefix}A`).value || 1);
        ratioB = parseInputToDecimal(document.getElementById(`ratio${prefix}B`).value || 1);
        ratioC = parseInputToDecimal(document.getElementById(`ratio${prefix}C`).value || 1);
        allocateAmount = parseInputToDecimal(document.getElementById(`allocate${prefix}`).value || 1);
    } else {
        ratioA = parseInputToDecimal(document.getElementById(`ratio${prefix}A`).value || 1);
        ratioB = parseInputToDecimal(document.getElementById(`ratio${prefix}B`).value || 1);
        allocateAmount = parseInputToDecimal(document.getElementById(`allocate${prefix}`).value || 1);
    }

    // 验证输入
    if (ratioA.lt(0) || ratioB.lt(0) || (ratioC && ratioC.lt(0)) || allocateAmount.lt(0)) {
        alert("请输入有效数值！");
        return;
    }

    // 检查点数是否足够
    let costType = dimension === 3 ? 'thirdDimensionPoints' : 'vectorPoints';
    let pointsAvailable = dimension === 3 ? 
        game.thirdDimensionPoints : game.vectorPoints;
    if (allocateAmount.gt(pointsAvailable)) {
        alert(`${costType === 'thirdDimensionPoints' ? '三维点' : '向量点'}不足！`);
        return;
    }

    // 执行分配
    if (dimension === 3) {
        game.allocationRatios[vectorKey] = {
            a: ratioA.toNumber(),
            b: ratioB.toNumber(),
            c: ratioC.toNumber()
        };
        const total = ratioA.add(ratioB).add(ratioC);
        vector.x = vector.x.add(allocateAmount.mul(ratioA).div(total));
        vector.y = vector.y.add(allocateAmount.mul(ratioB).div(total));
        vector.z = vector.z.add(allocateAmount.mul(ratioC).div(total));
        game.thirdDimensionPoints = game.thirdDimensionPoints.sub(allocateAmount);
    } else {
        game.allocationRatios[vectorKey] = {
            a: ratioA.toNumber(),
            b: ratioB.toNumber()
        };
        const total = ratioA.add(ratioB);
        vector.x = vector.x.add(allocateAmount.mul(ratioA).div(total));
        vector.y = vector.y.add(allocateAmount.mul(ratioB).div(total));
        game.vectorPoints = game.vectorPoints.sub(allocateAmount);
    }
    
    game.vectorUsed = true;
    calculateVectors();
    updateDisplay();
}

// 统一全部分配
function allocateAllPoints(vectorKey, dimension = 2) {
    const prefix = vectorKey.replace('vector', '');
    let pointsAvailable = dimension === 3 ? 
        game.thirdDimensionPoints : game.vectorPoints;
    document.getElementById(`allocate${prefix}`).value = pointsAvailable.toString();
    allocatePoints(vectorKey, dimension);
}

// 统一重新分配
function reallocate(vectorKey, dimension = 2) {
    const vector = game[vectorKey];
    if (!vector.unlocked && vectorKey != 'vectorA' && vectorKey != 'vectorE') return;

    // 计算返还点数
    const pointsToReturn = vector.x.add(vector.y).add(vector.z || 0);
    if (dimension === 3) {
        game.thirdDimensionPoints = game.thirdDimensionPoints.add(pointsToReturn);
    } else {
        game.vectorPoints = game.vectorPoints.add(pointsToReturn);
    }
    vector.x = new Decimal(0);
    vector.y = new Decimal(0);
    if (vector.z !== undefined) vector.z = new Decimal(0);
    game.vectorUsed = true;
    calculateVectors();
    updateDisplay();
}

function loadAllocationRatios(vectorKey, dimension = 2) {
    const ratios = game.allocationRatios[vectorKey];
    const prefix = vectorKey.replace('vector', '');
    
    if (dimension === 3) {
        document.getElementById(`ratio${prefix}A`).value = ratios.a;
        document.getElementById(`ratio${prefix}B`).value = ratios.b;
        document.getElementById(`ratio${prefix}C`).value = ratios.c;
    } else {
        document.getElementById(`ratio${prefix}A`).value = ratios.a;
        document.getElementById(`ratio${prefix}B`).value = ratios.b;
    }
}

function buyAutoClicker() {
    const cost = new Decimal(500);
    if (game.vectorPoints.gte(cost) && !game.upgrades.autoClicker) {
        game.vectorPoints = game.vectorPoints.sub(cost);
        game.upgrades.autoClicker = true;
        game.u2.unlocked = true;
        document.getElementById('autoClickerUpgrade').classList.add('purchased');
        updateDisplay();
    }
}

function buyVectorB() {
    const cost = new Decimal(4e18);
    if (game.scalar.gte(cost) && !game.upgrades.vectorB) {
        game.scalar = game.scalar.sub(cost);
        game.upgrades.vectorB = true;
        game.vectorB.unlocked = true;
        document.getElementById('vectorBUpgrade').classList.add('purchased');
        
        if (!game.achievements.twoDirections) {
            game.achievements.twoDirections = true;
            showAchievementNotification("成就达成：两个方向");
        } else {
            updateDisplay();
        }
    }
}

function buyVectorC() {
    if (game.vectorPoints.gte(10000) && !game.upgrades.vectorC) {
        game.vectorPoints = game.vectorPoints.sub(10000);
        game.upgrades.vectorC = true;
        game.vectorC.unlocked = true;
        document.getElementById('vectorCUpgrade').classList.add('purchased');
        updateDisplay();
    }
}

function buyVectorD() {
    const costScalar = new Decimal(1e90);
    const costLength = new Decimal(1e9);
    const costVector = new Decimal(1e6);
    
    if (game.scalar.gte(costScalar) && 
        game.length.gte(costLength) && 
        game.vectorPoints.gte(costVector) &&
        !game.upgrades.vectorD) {
        
        game.scalar = game.scalar.sub(costScalar);
        game.length = game.length.sub(costLength);
        game.vectorPoints = game.vectorPoints.sub(costVector);
        game.upgrades.vectorD = true;
        game.vectorD.unlocked = true;
        document.getElementById('vectorDUpgrade').classList.add('purchased');
        calculateVectors();
        updateDisplay();
    }
}

function get3DUpgradeCost(upgrade) {
    let baseCost = new Decimal(1);
    
    // 计算其他升级的初始价格
    let purchasedCount = 0;
    if (game.upgrades.lengthEarly) purchasedCount++;
    if (game.upgrades.autoBuy1D) purchasedCount++;
    if (game.upgrades.autoClickerUnlock) purchasedCount++;
    if (game.upgrades.vectorPointsAuto) purchasedCount++;
    
    return baseCost.add(purchasedCount);
}

function buyLengthEarly() {
    const cost = get3DUpgradeCost('lengthEarly');
    if (game.thirdDimensionPoints.gte(cost) && !game.upgrades.lengthEarly) {
        game.thirdDimensionPoints = game.thirdDimensionPoints.sub(cost);
        game.upgrades.lengthEarly = true;
        document.getElementById('lengthEarlyUpgrade').classList.add('purchased');
         
        updateDisplay();
    }
}

function buyAutoBuy1D() {
    const cost = get3DUpgradeCost('autoBuy1D');
    if (game.thirdDimensionPoints.gte(cost) && !game.upgrades.autoBuy1D) {
        game.thirdDimensionPoints = game.thirdDimensionPoints.sub(cost);
        game.upgrades.autoBuy1D = true;
        document.getElementById('autoBuy1DUpgrade').classList.add('purchased');
        game.automation.autoBuy1D = true;
        
        if (!game.achievements.autoEra) {
            game.achievements.autoEra = true;
            calculateVectorEffects();
            showAchievementNotification("成就达成：自动时代");
        } else {
            updateDisplay();
        }
    }
}

function buyAutoClickerUnlock() {
    const cost = get3DUpgradeCost('autoClickerUnlock');
    if (game.thirdDimensionPoints.gte(cost) && !game.upgrades.autoClickerUnlock) {
        game.thirdDimensionPoints = game.thirdDimensionPoints.sub(cost);
        game.upgrades.autoClickerUnlock = true;
        game.u2.unlocked = true;
        document.getElementById('autoClickerUpgrade').classList.add('purchased');
        document.getElementById('autoClickerUnlockUpgrade').classList.add('purchased');
        updateDisplay();
    }
}

function buyVectorPointsAuto() {
    const cost = get3DUpgradeCost('vectorPointsAuto');
    if (game.thirdDimensionPoints.gte(cost) && !game.upgrades.vectorPointsAuto) {
        game.thirdDimensionPoints = game.thirdDimensionPoints.sub(cost);
        game.upgrades.vectorPointsAuto = true;
        document.getElementById('vectorPointsAutoUpgrade').classList.add('purchased');
        updateDisplay();
    }
}

function buyVectorF() {
    const cost = new Decimal(10);
    if (game.thirdDimensionPoints.gte(cost) && !game.upgrades.vectorF) {
        game.thirdDimensionPoints = game.thirdDimensionPoints.sub(cost);
        game.upgrades.vectorF = true;
        game.vectorF.unlocked = true;
        document.getElementById('vectorFUpgrade').classList.add('purchased');
        updateDisplay();
    }
}

function buyAreaUnlock() {
    const cost = new Decimal(10);
    if (game.thirdDimensionPoints.gte(cost) && !game.upgrades.areaUnlock) {
        game.thirdDimensionPoints = game.thirdDimensionPoints.sub(cost);
        game.upgrades.areaUnlock = true;
        document.getElementById('areaBtn').style.display = 'inline-block';
        document.getElementById('areaUnlockUpgrade').classList.add('purchased');
        updateDisplay();
    }
}

function buyLengthExponent() {
    if (game.thirdDimensionPoints.gte(game.lengthExponent.cost) && game.lengthExponent.level.lt(7)) {
        game.thirdDimensionPoints = game.thirdDimensionPoints.sub(game.lengthExponent.cost);
        game.lengthExponent.level = game.lengthExponent.level.add(1);
        game.lengthExponent.cost = game.lengthExponent.cost.add(1);
        updateDisplay();
    }
}

function buyChallengesUnlock() {
    const cost = new Decimal(1000);
    if (game.thirdDimensionPoints.gte(cost) && !game.upgrades.challengesUnlock) {
        game.thirdDimensionPoints = game.thirdDimensionPoints.sub(cost);
        game.upgrades.challengesUnlock = true;
        document.getElementById('challengesUnlockUpgrade').classList.add('purchased');
        document.getElementById('challengesBtn').style.display = 'inline-block';
        document.getElementById('challengeConfirmLabel').style.display = 'block';
        updateDisplay();
    }
}

function buyEExponentUpgrade() {
    const cost = new Decimal(100);
    if (game.thirdDimensionPoints.gte(cost) && !game.upgrades.eExponent) {
        game.thirdDimensionPoints = game.thirdDimensionPoints.sub(cost);
        game.upgrades.eExponent = true;
        document.getElementById('eExponentUpgrade').classList.add('purchased');
        calculateVectorEffects();
        updateDisplay();
    }
}

function buyVectorG() {
    const cost = new Decimal('8.8e26').div(PLANCK_LENGTH).pow(2).mul(1e20);
    if (game.area.gte(cost) && !game.upgrades.vectorG) {
        game.area = game.area.sub(cost);
        game.upgrades.vectorG = true;
        game.vectorG.unlocked = true;
        document.getElementById('vectorGUpgrade').classList.add('purchased');
        updateDisplay();
    }
}

function buyVolumeUnlock() {
    const cost = new Decimal(15000);
    if (game.thirdDimensionPoints.gte(cost) && !game.upgrades.volumeUnlock) {
        game.thirdDimensionPoints = game.thirdDimensionPoints.sub(cost);
        game.upgrades.volumeUnlock = true;
        document.getElementById('volumeBtn').style.display = 'inline-block';
        document.getElementById('volumeUnlockUpgrade').classList.add('purchased');
        if (!game.achievements.realWorld) {
            game.achievements.realWorld = true;
            showAchievementNotification("成就达成：真实世界");
        } else {
            updateDisplay();
        }
    }
}

function toggleChallenge(challengeId) {
    const progress = game.challenges.progress[challengeId];
    if (game.challenges.progress[challengeId].active) {
        if (isChallengeComplete(challengeId)) {
            completeChallenge(challengeId);
        } else {
            progress.active = false;
            game.challenges.active = null;
            thirdDimension();
        }
        return;
    }
    
    if (game.settings.challengeConfirm && !confirm(
        "进入挑战将强制进行一次三维重置。在挑战中，游戏将会变得更难，但完成挑战后你将获得奖励。确定要进入挑战吗？"
    )) return;
    
    game.challenges.active = challengeId;
    progress.active = true;
    thirdDimension();
}

function isChallengeComplete(challengeId) {
    if (!game.challenges.progress[challengeId].active) return false;
    
    const progress = game.challenges.progress[challengeId].completed;
    return game.scalar.gte(challengeGoals[challengeId][progress.min(4).toNumber()]);
}

function toggleAutoBuy1D() {
    game.automation.autoBuy1D = document.getElementById('autoBuy1DToggle').checked;
}

function completeChallenge(challengeId) {
    const progress = game.challenges.progress[challengeId];
    if (progress.completed.lt(5)) progress.completed = progress.completed.add(1);
    if (challengeId === 'c2' && !game.achievements.uselessVectorsReal && progress.completed.gte(4)) {
        game.achievements.uselessVectorsReal = true;
        document.getElementById('eExponentUpgrade').style.display = 'inline-flex';
        showAchievementNotification("成就达成：真的，搞这么多向量，有什么用！");
    }
    if (progress.completed.gte(5)) {
        if (game.stats.timeSinceThirdDim.lt(game.stats.challengeRecordTime[challengeId])) {
            game.stats.challengeRecordTime[challengeId] = game.stats.timeSinceThirdDim;
        }
    }
    progress.active = false;
    game.challenges.active = null;
    
    showAchievementNotification(`${challengeId.toUpperCase()}完成 ${formatNumber(progress.completed)}/5`);
    
    thirdDimension();
}

function showTab(tabName) {
    document.querySelectorAll('.tabContent').forEach(tab => tab.style.display = 'none');
    document.getElementById(tabName).style.display = 'block';
    game.currentTab = tabName;
    
    // 获取该主标签上次保存的子标签状态
    const subTab = game.currentSubTabs[tabName];
    if (subTab) showSubTab(subTab);

    updateButtonStates();
}

function showSubTab(subTabName) {
    document.querySelectorAll('.subTabContent').forEach(tab => tab.style.display = 'none');
    const parentTab = game.currentTab;
    game.currentSubTabs[parentTab] = subTabName;
    const element = document.getElementById(subTabName);
    if (element) element.style.display = 'block';

    if (subTabName === '2dVector') {
        ['vectorA', 'vectorB', 'vectorC', 'vectorD'].forEach(v => loadAllocationRatios(v));
    }
    if (subTabName === '3dVector') {
        ['vectorE', 'vectorF', 'vectorG'].forEach(v => loadAllocationRatios(v, 3));
    }

    updateButtonStates();
}

function updateButtonStates() {
    // 主标签按钮状态
    const tabStates = {
        '1dTab': { active: game.currentTab === '1d', class: '' },
        '2dTab': { active: game.currentTab === '2d', class: 'blue' },
        '3dTab': { active: game.currentTab === '3d', class: 'green' },
        'automationTab': { active: game.currentTab === 'automation', class: '' },
        'achievementsTab': { active: game.currentTab === 'achievements', class: '' },
        'statsTab': { active: game.currentTab === 'stats', class: '' },
        'settingsTab': { active: game.currentTab === 'settings', class: '' }
    };

    // 更新主标签按钮
    Object.entries(tabStates).forEach(([id, state]) => {
        const btn = document.getElementById(id);
        if (btn) {
            btn.className = `${state.class} ${state.active ? 'active' : ''}`.trim();
        }
    });

    // 子标签处理函数
    const updateSubTabs = (tabId, buttons, activeClass = '') => {
        const currentSub = game.currentSubTabs[tabId];
        buttons.forEach(btnId => {
            const btn = document.getElementById(btnId);
            if (btn) {
                const isActive = btn.getAttribute('onclick').includes(currentSub);
                btn.className = `${activeClass} ${isActive ? 'active' : ''}`.trim();
            }
        });
    };

    // 更新各标签页的子按钮
    if (game.currentTab === '1d') {
        updateSubTabs('1d', ['1dUpgradesBtn','lengthBtn']);
    }
    
    if (game.currentTab === '2d') {
        updateSubTabs('2d', ['vectorBtn', 'upgradesBtn','areaBtn'], 'blue');
    }
    
    if (game.currentTab === '3d') {
        updateSubTabs('3d', ['vector3dBtn', 'upgrades3dBtn'], 'green');
        updateSubTabs('3d', ['challengesBtn'], 'purple');
    }
}

function saveGame() {
    // 加密存档
    let saveData = btoa(JSON.stringify(game));
    localStorage.setItem('dimensionJumpSave', saveData);
    
    // 显示保存通知
    showSaveNotification();
}

function loadGame() {
    try {
        const saveData = localStorage.getItem('dimensionJumpSave');
        if (!saveData) {
            game = defaultGame;
            return;
        }

        const decoded = JSON.parse(atob(saveData));
        
        game = deepMerge(defaultGame, decoded);
        convertToDecimal(game);
        game.version = defaultGame.version;
        
        // 恢复界面状态
        document.getElementById('2dTab').style.display = 
            game.hasAscended ? 'inline-block' : 'none';
        document.getElementById('3dTab').style.display = 
            game.hasThirdDimension ? 'inline-block' : 'none';
        document.getElementById('automationTab').style.display = 
            game.upgrades.autoBuy1D ? 'inline-block' : 'none';

        document.getElementById('confirmLabel').style.display = 
            game.hasAscended ? 'block' : 'none';
        document.getElementById('thirdDimensionConfirmLabel').style.display = 
            game.hasThirdDimension ? 'block' : 'none';
        document.getElementById('challengeConfirmLabel').style.display = 
            game.upgrades.challengesUnlock ? 'block' : 'none';

        document.getElementById('thirdDimensionBtn').style.display = 
            game.achievements.breakInfinity ? 'flex' : 'none';
        document.getElementById('thirdDimensionPointsDisplay').style.display = 
            game.hasThirdDimension ? 'block' : 'none';
        document.getElementById('lengthBtn').style.display = 
            game.lengthUnlocked ?  'inline-block' : 'none';
        document.getElementById('areaBtn').style.display =
            game.upgrades.areaUnlock ? 'inline-block' : 'none';
        document.getElementById('volumeBtn').style.display =
            game.upgrades.volumeUnlock ? 'inline-block' : 'none';
        document.getElementById('challengesBtn').style.display = 
            game.upgrades.challengesUnlock ? 'inline-block' : 'none';

        document.getElementById('eExponentUpgrade').style.display =
            game.achievements.uselessVectorsReal ? 'inline-flex' : 'none';

        document.getElementById('resetConfirm').checked = game.settings.confirm;
        document.getElementById('thirdDimensionResetConfirm').checked = game.settings.thirdDimensionConfirm;
        document.getElementById('challengeConfirm').checked = game.settings.challengeConfirm;

        const upgrades = Object.entries(game.upgrades).map(([key]) => ({
            id: `${key}Upgrade`,
            condition: game.upgrades[key]
        }));

        upgrades.forEach(u => {
            if (u.condition) {
                document.getElementById(u.id).classList.add('purchased');
            }
        });
        if (game.achievements.vectorDecrement) {
            Object.keys(challengeGoals).forEach(key => {
                challengeGoals[key] = challengeGoals[key].map(x => x.pow(0.5));
            });
        }
    } catch (e) {
        console.error("加载存档失败:", e);
    }
}

// ========== 工具函数 ==========
function deepMerge(target, source) {
    const result = { ...target };
    for (const key in target) {
        if (target[key] instanceof Object && !(target[key] instanceof Decimal)) {
            result[key] = deepMerge(target[key], source[key] || {});
        } else {
            result[key] = source[key] !== undefined ? source[key] : target[key];
        }
    }
    return result;
}

function convertToDecimal(obj) {
    for (const key in obj) {
        if (obj[key] && typeof obj[key] === 'object' && !(obj[key] instanceof Decimal)) {
            convertToDecimal(obj[key]); // 递归处理子对象（排除 Decimal）
        } else if (typeof obj[key] === 'string' && !isNaN(obj[key])) {
            obj[key] = new Decimal(obj[key]); // 转换字符串数字
        } else if (typeof obj[key] === 'number') {
            obj[key] = new Decimal(obj[key]); // 转换普通数字
        }
    }
}

function importSave() {
    let saveString = prompt('请输入存档代码:');
    if (saveString) {
        try {
            const decoded = JSON.parse(atob(saveString));
            game = deepMerge(defaultGame, decoded);
            convertToDecimal(game);
            showAchievementNotification("存档导入成功");
            saveGame();
            location.reload();
        } catch (e) {
            alert('存档无效！');
        }
    }
}

function exportSave() {
    const saveData = localStorage.getItem('dimensionJumpSave');
    const container = document.getElementById("exportContainer");
    const textarea = document.getElementById("exportOutput");
    textarea.value = saveData;
    container.style.display = "block";
}

function copySave() {
      const textarea = document.getElementById("exportOutput");
      textarea.select();
    try {
        document.execCommand("copy");
        alert("复制成功！");
    } catch (e) {
        alert("复制失败，请手动选择文本复制！");
    }
}

function closeExport() {
     document.getElementById("exportContainer").style.display = "none";
}

function importFromFile() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.txt,.json';
    input.onchange = e => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = event => {
            try {
                const decoded = JSON.parse(atob(event.target.result));
                game = deepMerge(defaultGame, decoded);
                convertToDecimal(game);
                showAchievementNotification("存档导入成功");
                saveGame();
                location.reload();
            } catch (e) {
                alert('导入失败：文件格式不正确');
            }
        };
        reader.readAsText(file);
    };
    input.click();
}

function exportToFile() {
    const saveData = btoa(JSON.stringify(game));
    const blob = new Blob([saveData], {type: 'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'dimension_jump_save.txt';
    a.click();
    URL.revokeObjectURL(url);
}

let resetCounter = 0;
function tryHardReset() {
    resetCounter++;
    
    if (resetCounter >= 10) {
        if (confirm('确定要硬重置吗？所有进度将丢失！')) {
            hardReset();
        } else {
            resetCounter = 0;
        }  
    } else {
        alert(`再点击${10 - resetCounter}次确认硬重置`);
    }
}

function hardReset() {
    localStorage.removeItem('dimensionJumpSave');
    alert('游戏已重置！');
    location.reload();
}

// 通知队列管理
const NotificationSystem = {
    queue: [],
    isShowing: false,
    container: null,

    init() {
        this.container = document.createElement('div');
        this.container.className = 'notification-container';
        document.body.appendChild(this.container);
    },

    show(type, message, duration = 2000) {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = message;
        this.queue.push({ element: notification, duration });

        if (!this.isShowing) {
            this.processQueue();
        }
    },

    processQueue() {
        if (this.queue.length === 0) {
            this.isShowing = false;
            return;
        }

        this.isShowing = true;
        const { element, duration } = this.queue.shift();
        this.container.appendChild(element);

        setTimeout(() => {
            element.classList.add('fade-out');
            setTimeout(() => {
                element.remove();
                this.processQueue();
            }, 300);
        }, duration);
    }
};

function showSaveNotification() {
    NotificationSystem.show(
        'save',
        '游戏已保存！ <small>' + new Date().toLocaleTimeString() + '</small>'
    );
}

function showAchievementNotification(message) {
    NotificationSystem.show(
        'achievementNotif',
        `${message}`,
        3000  // 成就通知显示更久
    );
    updateDisplay();
}

// 自动保存
setInterval(() => {
    saveGame();
}, 60000);

// 自动化
setInterval(() => {
    const u2Level = game.u2.level.add(game.achievements.breakInfinity ? 1 : 0);
    if (game.u2.unlocked && u2Level.gt(0)) {
        let rate = getAutoClickerSpeed().mul(getMultiplier());
        if (game.challenges.active === 'c1') {
            let challengeCount = game.challenges.progress.c1.completed.add(1).min(5);
            const exponent = 0.95 - 0.1 * challengeCount.toNumber();
            rate = dilate(rate, exponent);
        }
        const gain = rate.div(20);
        game.scalar = game.scalar.add(gain);
    }

    // 自动获得向量点
    if (game.upgrades.vectorPointsAuto && game.scalar.gte(10000)) {
        game.vectorPoints = game.vectorPoints.add(calculateVecPoints().div(20));
    }

    // 自动购买一维升级
    if (game.upgrades.autoBuy1D && game.automation.autoBuy1D) {
        if (game.scalar.gte(game.u1.cost)) {
            buyU1(true);
        }
        if (game.u2.unlocked && game.scalar.gte(game.u2.cost)) {
            buyU2(true);
        }
    }

    game.length = game.length.add(getLengthGain().div(20));
    if (game.upgrades.areaUnlock) {
        game.area = game.area.add(getareaGain().div(20));
    }
    if (game.upgrades.volumeUnlock) {
        game.volume = game.volume.add(getVolumeGain().div(20));
    }

    game.stats.gameTime = game.stats.gameTime.add(0.05);
    game.stats.timeSinceAscend = game.stats.timeSinceAscend.add(0.05);
    game.stats.timeSinceThirdDim = game.stats.timeSinceThirdDim.add(0.05);
    updateDisplay();
}, 50);

setInterval(() => {
    if (game.scalar.gte(10000) && !game.achievements.d2) {
        game.achievements.d2 = true;
        showAchievementNotification("成就达成：二维化");
    }
    
    if (ax.gt(0) && ay.gt(0) && !game.achievements.max) {
        const ratio = ax.div(ay);
        if (ratio.sub(1.695).abs().lte(0.01)) {
            game.achievements.max = true;
            calculateVectorEffects();
            showAchievementNotification("成就达成：《最值问题》");
        }
    }
    
    if (game.vectorB.unlocked && getAutoClickerSpeed().gte(3e8) && !game.achievements.lightSpeed) {
        game.achievements.lightSpeed = true;
        calculateVectorEffects();
        showAchievementNotification("成就达成：光速点击");
    }
    
    if (game.hasAscended && game.scalar.gte(1e8) && 
        ax.eq(0) && ay.eq(0) && 
        (!game.vectorB.unlocked || (bx.eq(0) && by.eq(0))) && !game.vectorUsed && !game.achievements.uselessVectors) {
        game.achievements.uselessVectors = true;
        calculateVectors();
        showAchievementNotification("成就达成：搞这么多向量，有什么用！");
    }
    
    if (game.length.gte(1e6) && !game.achievements.longJourney) {
        game.achievements.longJourney = true;
        showAchievementNotification("成就达成：不积跬步，无以至千里");
    }

   if (game.vectorD.unlocked && 
        (ax.gte(1e7) || ay.gte(1e7)) &&
        !game.achievements.megaVector) {
        game.achievements.megaVector = true;
        game.achievements.max = true;
        calculateVectorEffects();
        showAchievementNotification("成就达成：巨型向量");
    }
    
    if (game.scalar.gte(Decimal.pow(2, 1024)) && !game.achievements.breakInfinity) {
        game.achievements.breakInfinity = true;
        document.getElementById('thirdDimensionBtn').style.display = 'flex';
        document.getElementById('thirdDimensionPointsDisplay').style.display = 'block';
        showAchievementNotification("成就达成：打破无限");
    }
    
    if (game.achievements.max && 
        (game.vectorB.x.eq(0) ^ game.vectorB.y.eq(0)) &&
        game.vectorC.x.eq(game.vectorC.y) && game.vectorC.x.gt(0) &&
        game.vectorD.x.eq(0) && game.vectorD.y.gt(0) &&
        !game.achievements.fourVectors) {
        game.achievements.fourVectors = true;
        showAchievementNotification("成就达成：四维主宰");
    }

    if (game.hasThirdDimension && !game.achievements.youAreHacker && 
        game.stats.timeSinceThirdDim.lte(666) && 
        game.scalar.gte(new Decimal(10).pow(66666).mul(6.6))) {
        game.achievements.youAreHacker = true;
        showAchievementNotification("成就达成：666，这个入是桂");
    }

    if (!game.achievements.spaceVectorBasic &&
        game.vectorE.x.eq(game.vectorE.y) && game.vectorE.y.eq(game.vectorE.z) && game.vectorE.x.gt(0)) {
        game.achievements.spaceVectorBasic = true;
        calculateVectors();
        showAchievementNotification("成就达成：空间向量初步");
    }

    if (game.upgrades.areaUnlock && !game.achievements.area1ym && game.area.gte(new Decimal(1e-48).div(PLANCK_LENGTH.pow(2)))) {
        game.achievements.area1ym = true;
        showAchievementNotification("成就达成：一ym见方");
    }

    if (game.vectorF.unlocked && !game.achievements.mirrorF &&
        ex.eq(fz) && ey.eq(fy) && ez.eq(fx) &&
        ex.gt(0) && ey.gt(0) && ez.gt(0) &&
        !ex.eq(ey) && !ey.eq(ez) && !ex.eq(ez)) {
        game.achievements.mirrorF = true;
        calculateVectorEffects();
        showAchievementNotification("成就达成：zyx.");
    }

    if (!game.achievements.notChallenging && 
        game.challenges.progress.c1.completed.gte(5) &&
        game.challenges.progress.c2.completed.gte(5) &&
        game.challenges.progress.c3.completed.gte(5)) {
        
        const totalTime = game.stats.challengeRecordTime.c1
                         .add(game.stats.challengeRecordTime.c2)
                         .add(game.stats.challengeRecordTime.c3);
        
        if (totalTime.lt(5.14)) {
            game.achievements.notChallenging = true;
            showAchievementNotification("成就达成：...不是很有挑战性？");
        }
    }

    if (!game.achievements.beyondWorld && 
        game.length.gte(new Decimal('e1e9'))) {
        game.achievements.beyondWorld = true;
        showAchievementNotification("成就达成：世界之外");
    }
   
    if (!game.achievements.hundredKDimensions && 
        game.stats.ascendCount.gte(100000)) {
        game.achievements.hundredKDimensions = true;
        showAchievementNotification("成就达成：100001维");
    }
    
    if (!game.achievements.abcdefg && 
        game.vectorG.unlocked && 
        gGain.gte(2)) {
        game.achievements.abcdefg = true;
        showAchievementNotification("成就达成：ABCDEFG");
    }
    if (!game.achievements.hundredKThirdDim && game.stats.thirdDimCount.gte(100000)) {
        game.achievements.hundredKThirdDim = true;
        showAchievementNotification("成就达成：肝帝一肝一肝又一肝");
    }
    if (!game.achievements.vectorDecrement && game.challenges.active === 'c3') {
        const progress = game.challenges.progress.c3.completed.add(1).min(5);
        const timeElapsed = game.stats.timeSinceThirdDim;
        const decayFactor = new Decimal(2).pow(progress.mul(timeElapsed));
        if (decayFactor.gte(Decimal.pow(2,1024))) {
            game.achievements.vectorDecrement = true;
            Object.keys(challengeGoals).forEach(key => {
                challengeGoals[key] = challengeGoals[key].map(x => x.pow(0.5));
            });
            showAchievementNotification("成就达成：这游戏不是叫向量减量吗？");
        }
    }
}, 1000);

function createVectorUI(id, dimensions = 2, effects = []) {
    const upperId = id.toUpperCase();
    const ratios = 
        `<input type="number" id="ratio${upperId}A" min="0" value="1"> : 
         <input type="number" id="ratio${upperId}B" min="0" value="1">
         ${dimensions === 3 ? ` : <input type="number" id="ratio${upperId}C" min="0" value="1">` : ''}`;
    const effectDisplays = effects.map((desc, index) => 
        `${desc.replace(/\{\{value\}\}/g, `<span id="current${upperId}Gain${index === 0 ? '' : index+1}">1</span>`)}`
    ).join('，');

    return `
    <div id="${id}Container" style="display:none; margin-top: 30px;">
        <div style="display: flex; gap: 20px; margin: 20px">
            <div class="d${dimensions}Text">
                <span class="vector${dimensions === 3 ? '3d' : ''}">${id}</span> = (<span id="vec${upperId}X">0</span>, <span id="vec${upperId}Y">0</span>${dimensions === 3 ? `, <span id="vec${upperId}Z">0</span>` : ''})
            </div>
            <div>
                <div>按比例分配</div>
                ${ratios}
            </div>
            <div>
                分配点数: <input type="number" id="allocate${upperId}" min="1" value="1">
                <button onclick="allocatePoints('vector${upperId}', ${dimensions})">分配</button>
                <button onclick="allocateAllPoints('vector${upperId}', ${dimensions})">全部分配</button>
            </div>
            <button onclick="reallocate('vector${upperId}', ${dimensions})">重新分配</button>
        </div>
        <div>当前：${effectDisplays} <span class="formula" id="${id}Formula"></span></div>
    </div>`;
}

function createUpgradeCard(id, index, title, costText, onClick, is3D = false, display = true) {
    return `
    <div class="${is3D ? 'vector3dUpgrade' : 'vectorUpgrade'}" id="${id}"${!display ? ` style="display:none"` : ''}>
        <div class="index">U${index}</div>
        <div>${title}</div>
        <div>花费：${costText}</div>
        <button onclick="${onClick}">购买</button>
    </div>`;
}

function createAchievement(id, title, tooltip) {
    return `
    <div class="achievement tooltip" id="${id}Achievement">
        ${title}
        <span class="tooltiptext">${tooltip}</span>
    </div>`;
}

document.addEventListener('dblclick', function(e) {
    e.preventDefault();
}, { passive: false });

document.addEventListener('DOMContentLoaded', function() {
    // 初始化设置
    document.getElementById('2dVector').innerHTML += 
        createVectorUI('a', 2, [`U1等级×{{value}}`]) +
        createVectorUI('b', 2, [`自动点击速度^{{value}}`]) +
        createVectorUI('c', 2, [
            `<span class="vector">a</span>,<span class="vector">b</span>×{{value}}`
        ]) +
        createVectorUI('d', 2, [
        `<span class="vector">a</span>,<span class="vector">b</span>,<span class="vector">c</span>坐标^{{value}}`,
        `<span class="vector">d</span>×{{value}}`
        ]);
    
    document.getElementById('3dVector').innerHTML += 
        createVectorUI('e', 3, [`长度获取×{{value}}`]) +
        createVectorUI('f', 3, [`向量点获取×{{value}}`]) +
        createVectorUI('g', 3, [`数量获取^{{value}}`]);

    document.getElementById('2dUpgrades').innerHTML = [
        createUpgradeCard('autoClickerUpgrade', 1, '解锁自动点击器', '500向量点', 'buyAutoClicker()'),
        createUpgradeCard('vectorBUpgrade', 2, '解锁<span class="vector">b</span>', '4e18数量', 'buyVectorB()'),
        createUpgradeCard('vectorCUpgrade', 3, '解锁<span class="vector">c</span>', '10000向量点', 'buyVectorC()'),
        createUpgradeCard('vectorDUpgrade', 4, '解锁<span class="vector">d</span>', '1e90数量 1e9普朗克长度 1e6向量点', 'buyVectorD()')
    ].join('');


    document.getElementById('3dUpgrades').innerHTML = [
        createUpgradeCard(
            'lengthEarlyUpgrade', 1, '长度获取提前1e30倍',
            '<span id="lengthEarlyCost">1</span>三维点', 'buyLengthEarly()', true
        ),
        createUpgradeCard(
            'autoBuy1DUpgrade', 2, '自动购买一维升级',
            '<span id="autoBuy1DCost">1</span>三维点', 'buyAutoBuy1D()', true
        ),
        createUpgradeCard(
            'autoClickerUnlockUpgrade', 3, '初始解锁自动点击器',
            '<span id="autoClickerUnlockCost">1</span>三维点', 'buyAutoClickerUnlock()', true
        ),
        createUpgradeCard(
            'vectorPointsAutoUpgrade', 4, '每秒获得升维后获取的100%向量点',
            '<span id="vectorPointsAutoCost">1</span>三维点', 'buyVectorPointsAuto()', true
        ),
        createUpgradeCard(
            'vectorFUpgrade', 5, '解锁<span class="vector3d">f</span>',
            '10三维点', 'buyVectorF()', true
        ),
        createUpgradeCard(
            'areaUnlockUpgrade', 6, '解锁面积',
            '10三维点', 'buyAreaUnlock()', true
        ),
        createUpgradeCard(
            'challengesUnlockUpgrade', 7, '解锁挑战',
            '1000三维点', 'buyChallengesUnlock()', true
        ),
        createUpgradeCard(
            'eExponentUpgrade', 8, '<span class="vector3d">e</span>效果指数平方(实际上并没有什么卵用)',
            '100三维点', 'buyEExponentUpgrade()', true, false
        ),
        createUpgradeCard(
            'vectorGUpgrade', 9, '解锁<span class="vector3d">g</span>',
            '1e20 uni²', 'buyVectorG()', true
        ),
        createUpgradeCard(
            'volumeUnlockUpgrade', 10, '解锁体积',
            '15000三维点', 'buyVolumeUnlock()', true
        )
    ].join('') + `
        <div class="upgrade3d">
            <div>长度获取公式指数改善</div>
            <div>当前：1/<span id="lengthExponent">9</span></div>
            <div>花费：<span id="lengthExponentCost">1</span>三维点</div>
            <button onclick="buyLengthExponent()" class="green">购买</button>
        </div>`;

    document.getElementById('achievements').innerHTML = [
        createAchievement('d2', '二维化', '达到10000数量<br>奖励：升级1等级+1'),
        createAchievement('max', '《最值问题》', '通过调整比例使<span class="vector">a</span>对U1的增益达到最大值<br>奖励：<span class="vector">a</span>对U1的增益×2'),
        createAchievement('twoDirections', '两个方向', '解锁<span class="vector">b</span><br>奖励：向量点获取×1.1'),
        createAchievement('lightSpeed', '光速点击', '自动点击速度达到3e8/s<br>奖励：<span class="vector">b</span>效果指数+0.1'),
        createAchievement('uselessVectors', '搞这么多向量，有什么用！', '在升维中所有向量为0且数量达到1e8<br>奖励：<span class="vector">c</span>×1.5'),
        createAchievement('longJourney', '不积跬步，无以至千里', '达到1e6普朗克长度<br>奖励：长度获取公式改善'),
        createAchievement('fourVectors', '四维主宰', '使四个向量的加成都达到最大<br>奖励：长度获取×2'),
        createAchievement('megaVector', '巨型向量', '<span class="vector">a</span>的任一坐标超过1e7<br>奖励：<span class="vector">a</span>增益公式改善'),
        createAchievement('breakInfinity', '打破无限', '数量超过1.79e308<br>奖励：自动点击器等级+1'),
        createAchievement('thirdDimension', '三维世界', '进行一次三维重置<br>奖励：向量点获取×2'),
        createAchievement('youAreHacker', '666，这个入是桂', '在一次三维重置中，在666s内使数量达到6.6e66666<br>奖励：略微提升向量点获取'),
        createAchievement('autoEra', '自动时代', '解锁自动化<br>奖励：<span class="vector">b</span>效果指数+0.1'),
        createAchievement('spaceVectorBasic', '空间向量初步', '使<span class="vector3d">e</span>的增益达到最大<br>奖励：<span class="vector3d">e</span>×2'),
        createAchievement('area1ym', '一ym见方', '面积达到1ym²<br>奖励：略微增加面积对长度的增益'),
        createAchievement('mirrorF', 'zyx.', '若<span class="vector3d">e</span>的坐标为(x,y,z)，使<span class="vector3d">f</span>的坐标为(z,y,x)且x≠y≠z,x,y,z>0<br>奖励：略微增加<span class="vector3d">e</span>的增益'),
        createAchievement('uselessVectorsReal', '真的，搞这么多向量，有什么用！', '完成4次C2<br>奖励：解锁一个新的三维升级'),
        createAchievement('notChallenging', '...不是很有挑战性？', '所有挑战的最快完成时间之和小于5.14s<br>奖励：向量点获得随游戏时间增加<br>当前: ×<span id="notChallengingEffect">1</span>'),
        createAchievement('beyondWorld', '世界之外', '到达1mlt<br>奖励：面积增加向量点获取'),
        createAchievement('hundredKDimensions', '100001维', '升维100000次<br>奖励：升维次数增加面积获取<br>当前: ×<span id="hundredKDimensionsEffect">1</span>'),
        createAchievement('abcdefg', 'ABCDEFG', '<span class="vector3d">g</span>的增益超过^2<br>奖励：向量点获取×4'),
        createAchievement('realWorld', '真实世界', '解锁体积<br>奖励：体积增加面积获取'),
        createAchievement('hundredKThirdDim', '肝帝一肝一肝又一肝', '三维100000次<br>奖励：三维次数增加二维次数获取<br>当前: ×<span id="hundredKThirdDimEffect">1</span>'),
        createAchievement('vectorDecrement', '这游戏不是叫向量减量吗？', '使向量点的减益超过/1.79e308<br>奖励：所有挑战的数量目标^0.5')
    ].join('');

    document.getElementById('resetConfirm').onchange = e => game.settings.confirm = e.target.checked;
    document.getElementById('thirdDimensionResetConfirm').onchange = e => game.settings.thirdDimensionConfirm = e.target.checked;
    document.getElementById('challengeConfirm').onchange = e => game.settings.challengeConfirm = e.target.checked;
    document.addEventListener('keydown', function(e) {
        if (document.visibilityState === 'visible') {
            if (e.code === 'KeyS' && !e.repeat) {
                clickScalar();
                document.getElementById('clickButton').classList.add('active');
                setTimeout(() => {
                    document.getElementById('clickButton').classList.remove('active');
                }, 100);
                e.preventDefault();
            }

            if (e.code === 'KeyA') {
                tryAscend();
                e.preventDefault();
            }

            if (e.code === 'KeyT') {
                tryThirdDimension();
                e.preventDefault();
            }
        }
    });
    NotificationSystem.init();
    // 加载存档
    loadGame();
    calculateVectors();
    updateDisplay();
    showTab(game.currentTab);
});
    </script>
</body>
</html>
